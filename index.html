<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í˜„ì¥ ì‚¬ì§„ Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/piexifjs/1.0.6/piexif.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.js"></script>
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #e5e5ea;
            --text-tertiary: #a1a1a6;
            --border-color: #3a3a3c;
            --shadow: rgba(0,0,0,0.5);
        }
        
        body.light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f2f2f7;
            --bg-tertiary: #ffffff;
            --text-primary: #000000;
            --text-secondary: #1c1c1e;
            --text-tertiary: #8e8e93;
            --border-color: #d1d1d6;
            --shadow: rgba(0,0,0,0.1);
        }
        
        body { 
            font-family: -apple-system, sans-serif; 
            padding: 20px; 
            background: var(--bg-primary); 
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            margin: 0;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 5px;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            color: var(--text-primary);
        }
        .settings-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
        }
        .back-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .card { 
            background: var(--bg-secondary); 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            box-shadow: 0 4px 12px var(--shadow); 
            box-sizing: border-box;
            border: 1px solid var(--border-color);
        }
        h3 { 
            margin: 0 0 12px 0; 
            font-size: 16px; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 8px; 
            color: var(--text-secondary); 
        }
        
        .row { display: flex; gap: 10px; margin-bottom: 8px; align-items: stretch; width: 100%; }
        .col-key { 
            width: 65px; 
            flex: none !important; 
            font-weight: bold; 
            background: var(--bg-tertiary); 
            color: var(--text-tertiary); 
            border: 1px solid var(--border-color); 
            padding: 12px 5px; 
            border-radius: 8px; 
            text-align: center; 
            font-size: 13px; 
            box-sizing: border-box; 
        }
        input, select { 
            flex: 1; 
            min-width: 0; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 15px; 
            background: var(--bg-tertiary); 
            color: var(--text-primary); 
            box-sizing: border-box; 
        }
        
        .input-wrapper { position: relative; flex: 1; display: flex; align-items: center; min-width: 0; }
        .input-wrapper input { flex: 1; min-width: 0; }
        .input-with-clear { padding-right: 40px !important; }
        .clear-btn { 
            position: absolute; 
            right: 8px; 
            background: #8e8e93; 
            border: none; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            color: white; 
            font-size: 14px; 
            cursor: pointer; 
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .clear-btn:active { background: #636366; }
        
        input[type="date"] {
            color-scheme: light dark;
            -webkit-appearance: none;
        }
        body.light-mode input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0);
        }
        body:not(.light-mode) input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        button { padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #0a84ff; color: white; width: 100%; margin-top: 10px; }
        .btn-green { background: #30d158; color: white; width: 100%; margin-top: 10px; }
        .btn-red { background: #ff453a; color: white; width: 70px; font-size: 13px; flex-shrink: 0; }
        .btn-gray { background: #8e8e93; color: white; width: 70px; font-size: 13px; flex-shrink: 0; }
        .btn-orange { background: #ff9f0a; color: white; width: 100%; margin-top: 10px; }
        .btn-purple { background: #bf5af2; color: white; width: 100%; margin-top: 10px; }
        
        #status { text-align: center; margin-top: 15px; font-weight: 600; color: #0a84ff; }
        #openFilesBtn { display: none; }
        
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .toggle-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #8e8e93;
            transition: .3s;
            border-radius: 31px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #0a84ff;
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        .screen { display: none; }
        .screen.active { display: block; }
        
        .setting-description {
            text-align: center;
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 10px;
        }
        
        .cloud-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .cloud-status.connected {
            border-color: #30d158;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #8e8e93;
        }
        .status-indicator.connected {
            background: #30d158;
        }
        .cloud-email {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }
    </style>
</head>
<body>

<!-- ë©”ì¸ í™”ë©´ -->
<div id="mainScreen" class="screen active">
    <div class="header">
        <h1>í˜„ì¥ ì‚¬ì§„ Pro</h1>
        <button class="settings-btn" onclick="showSettings()">âš™ï¸</button>
    </div>

    <div class="card">
        <h3>ğŸ“‹ í‘œ ë‚´ìš© ì…ë ¥</h3>
        <div id="tableFields"></div>
    </div>

    <div class="card">
        <h3>ğŸ’¾ í…œí”Œë¦¿ ê´€ë¦¬</h3>
        <div class="row">
            <select id="templateList" onchange="loadTemplate()"><option value="">í…œí”Œë¦¿ ì„ íƒ</option></select>
            <button class="btn-red" onclick="deleteTemplate()">ì‚­ì œ</button>
        </div>
        <div class="row">
            <div class="input-wrapper">
                <input type="text" id="newTemplateName" class="input-with-clear" placeholder="ìƒˆ ì´ë¦„" oninput="toggleClearBtn()">
                <button class="clear-btn" id="clearNameBtn" onclick="clearTemplateName()">âœ•</button>
            </div>
            <button class="btn-gray" onclick="saveTemplate()">ì €ì¥</button>
        </div>
    </div>

    <div class="card">
        <input type="file" id="imageInput" multiple accept="image/jpeg,image/jpg,image/heic,image/heif" style="display: none;">
        <button class="btn-blue" onclick="document.getElementById('imageInput').click()">ğŸ“¸ ì‚¬ì§„ ì„ íƒ & ì‘ì—… ì‹œì‘</button>
        <div id="status">ëŒ€ê¸° ì¤‘...</div>
        <button id="cancelUploadBtn" class="btn-red" onclick="cancelUpload()" style="display: none; width: 100%; margin-top: 10px;">âŒ ì—…ë¡œë“œ ì·¨ì†Œ</button>
        <button id="openFilesBtn" class="btn-green" onclick="openFilesApp()">ğŸ“‚ íŒŒì¼ ì•± ì—´ê¸°</button>
        <button id="uploadToCloudBtn" class="btn-purple" onclick="manualUploadToCloud()" style="display: none;">â˜ï¸ Dropboxì— ì—…ë¡œë“œ</button>
        <button id="openDropboxBtn" class="btn-purple" onclick="openDropboxFolder()" style="display: none;">ğŸ“‚ Dropboxì—ì„œ ë³´ê¸°</button>
    </div>

    <div class="card">
        <h3>ğŸ’¾ í…œí”Œë¦¿ ë°±ì—… & ë³µì›</h3>
        <button class="btn-blue" onclick="exportTemplates()">ğŸ“¤ í…œí”Œë¦¿ ë‚´ë³´ë‚´ê¸° (JSON)</button>
        <input type="file" id="importInput" accept="application/json" style="display: none;" onchange="importTemplates(event)">
        <button class="btn-green" onclick="document.getElementById('importInput').click()">ğŸ“¥ í…œí”Œë¦¿ ê°€ì ¸ì˜¤ê¸° (JSON)</button>
    </div>
    
    <div style="text-align: center; padding: 20px 0; color: var(--text-tertiary); font-size: 13px;">
        ë§Œë“  ì´ juneui
    </div>
</div>

<!-- ì„¤ì • í™”ë©´ -->
<div id="settingsScreen" class="screen">
    <div class="header">
        <button class="back-btn" onclick="showMain()">â† ë’¤ë¡œê°€ê¸°</button>
        <h1 style="margin-left: auto;">ì„¤ì •</h1>
    </div>

    <div class="card">
        <h3>ğŸ“¦ Dropbox ì—°ë™</h3>
        <div class="cloud-status" id="dropboxStatus">
            <div class="status-indicator" id="dropboxIndicator"></div>
            <span class="cloud-email" id="dropboxEmail">ì—°ê²°ë˜ì§€ ì•ŠìŒ</span>
        </div>
        
        <button class="btn-blue" id="dropboxConnectBtn" onclick="connectDropbox()">Dropbox ê³„ì • ì—°ê²°</button>
        <button class="btn-red" id="dropboxDisconnectBtn" onclick="disconnectDropbox()" style="display: none; width: 100%;">ì—°ê²° í•´ì œ</button>
        
        <div style="margin-top: 15px;">
            <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 5px;">
                ğŸ“ ì €ì¥ í´ë”:
            </label>
            <input type="text" id="dropboxFolderPath" 
                   placeholder="/í˜„ì¥ì‚¬ì§„" 
                   value="/í˜„ì¥ì‚¬ì§„"
                   style="width: 100%; padding: 12px; border: 1px solid var(--border-color); 
                          border-radius: 8px; font-size: 14px; background: var(--bg-tertiary); 
                          color: var(--text-primary); box-sizing: border-box;"
                   onchange="saveDropboxFolder()">
            <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 5px;">
                ì˜ˆ: /í˜„ì¥ì‚¬ì§„, /Photos, /Work ë“±
            </div>
        </div>
        
        <div class="toggle-row" style="margin-top: 15px;">
            <span class="toggle-label">ë‚ ì§œë³„ í•˜ìœ„ í´ë” ìƒì„±</span>
            <label class="switch">
                <input type="checkbox" id="dropboxDateFolder" onchange="saveDropboxFolder()" checked>
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-description">
            ON: /í˜„ì¥ì‚¬ì§„/2026/02/ <br>
            OFF: /í˜„ì¥ì‚¬ì§„/
        </div>
        
        <div class="toggle-row" style="margin-top: 15px;">
            <span class="toggle-label">Dropbox ìë™ ì—…ë¡œë“œ</span>
            <label class="switch">
                <input type="checkbox" id="dropboxAutoUpload" onchange="toggleDropboxSettings()">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="toggle-row" style="margin-top: 15px;">
            <span class="toggle-label">í™•ì¸ í›„ ì—…ë¡œë“œ</span>
            <label class="switch">
                <input type="checkbox" id="dropboxManualUpload" onchange="toggleDropboxSettings()">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="setting-description">
            âœ¨ ì˜êµ¬ ì‚¬ìš© ê°€ëŠ¥! ë²„íŠ¼ í´ë¦­ë§Œìœ¼ë¡œ ê°„í¸ ì—°ê²°
        </div>
    </div>

    <div class="card">
        <h3>ğŸ¨ í…Œë§ˆ ì„¤ì •</h3>
        <div class="toggle-row">
            <span class="toggle-label">ë‹¤í¬ ëª¨ë“œ</span>
            <label class="switch">
                <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-description">ë°ì€ í™”ë©´ì„ ì›í•˜ì‹œë©´ í† ê¸€ì„ ë„ì„¸ìš”</div>
    </div>

    <div class="card">
        <h3>ğŸ“ í‘œ í¬ê¸° ì„¤ì •</h3>
        <div style="padding: 10px 0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: var(--text-primary); font-size: 14px;">í‘œ í¬ê¸°</span>
                <span id="tableSizeValue" style="color: #0a84ff; font-weight: bold;">100%</span>
            </div>
            <input type="range" id="tableSizeSlider" min="50" max="150" value="100" 
                   style="width: 100%; height: 6px; border-radius: 3px; background: var(--bg-tertiary); 
                          border: 1px solid var(--border-color); cursor: pointer;"
                   oninput="updateTableSize(this.value)">
            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px; color: var(--text-tertiary);">
                <span>50%</span>
                <span>100%</span>
                <span>150%</span>
            </div>
        </div>
        <div class="setting-description">í‘œì˜ ì „ì²´ í¬ê¸°ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤</div>
    </div>

    <div class="card">
        <h3>ğŸ”„ ì•± ì—…ë°ì´íŠ¸</h3>
        <button class="btn-orange" onclick="updateApp()">ğŸ”„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸</button>
        <div class="setting-description">ìºì‹œë¥¼ ì‚­ì œí•˜ê³  ìµœì‹  ë²„ì „ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</div>
    </div>
</div>

<script>
    // ========== ì„¤ì • í‚¤ ==========
    const storageKey = 'photo_pro_v8_final';
    const themeKey = 'photo_pro_theme';
    const dropboxKey = 'photo_pro_dropbox';
    const tableSizeKey = 'photo_pro_table_size';
    
    // ========== Dropbox OAuth PKCE ì„¤ì • ==========
    const DROPBOX_CLIENT_ID = 'eafpljx4claj83h';
    const DROPBOX_REDIRECT_URI = window.location.href.split('#')[0].split('?')[0];
    
    // ========== ì „ì—­ ë³€ìˆ˜ ==========
    let dropboxAccessToken = null;
    let dropboxRefreshToken = null;
    let dropboxLastPath = null;
    let currentUploadXHR = null; // ì—…ë¡œë“œ ì·¨ì†Œìš©
    let currentZipBlob = null;
    let currentZipFileName = null;
    let tableSize = 100; 
    
    const statusText = document.getElementById('status');
    const openFilesBtn = document.getElementById('openFilesBtn');
    const today = new Date();
    const dateStr = `${today.getFullYear()}ë…„ ${String(today.getMonth() + 1).padStart(2, '0')}ì›” ${String(today.getDate()).padStart(2, '0')}ì¼`;
    
    let currentTemplateName = "";
    let currentData = [
        {k: "ê³µì‚¬ëª…", v: ""}, {k: "ì‹œë£Œë²ˆí˜¸", v: ""},
        {k: "ì¼ì", v: dateStr}, {k: "ì±„ì·¨êµ¬ë¶„", v: ""}, {k: "ì¡°ì‚¬ì", v: ""}
    ];

    // ========== EXIF ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ==========
    function formatDateForExif(date) {
        const d = (typeof date === 'string' || typeof date === 'number') ? new Date(date) : date;
        const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0');
        const h = String(d.getHours()).padStart(2, '0'), min = String(d.getMinutes()).padStart(2, '0'), s = String(d.getSeconds()).padStart(2, '0');
        return `${y}:${m}:${day} ${h}:${min}:${s}`;
    }

    function toRational(n) { 
        const t = 1.0E-6; 
        let num = 1, den = 1; 
        while (Math.abs(n - Math.round(n)) > t && den < 100000) { 
            n *= 10; 
            den *= 10; 
        } 
        return [Math.round(n), den]; 
    }
    
    function degToDmsRational(d) { 
        const abs = Math.abs(d); 
        const deg = Math.floor(abs); 
        const minF = (abs - deg) * 60; 
        const min = Math.floor(minF); 
        const sec = Math.round((minF - min) * 60 * 10000); 
        return [[deg, 1], [min, 1], [sec, 10000]]; 
    }

    async function getExifDateTime(file) {
        try {
            const metadata = await exifr.parse(file, {pick: ['DateTimeOriginal', 'CreateDate']});
            return (metadata && (metadata.DateTimeOriginal || metadata.CreateDate)) ? 
                new Date(metadata.DateTimeOriginal || metadata.CreateDate) : new Date(0);
        } catch (err) { 
            return new Date(0); 
        }
    }

    // ========== ì´ë¯¸ì§€ ì²˜ë¦¬ ==========
    document.getElementById('imageInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        
        openFilesBtn.style.display = 'none';
        document.getElementById('openDropboxBtn').style.display = 'none';
        document.getElementById('uploadToCloudBtn').style.display = 'none';
        statusText.innerText = 'ì‚¬ì§„ ë¶„ì„ ë° ì •ë ¬ ì¤‘...';
        
        const filesWithTime = await Promise.all(
            files.map(async (file) => ({
                file: file,
                time: await getExifDateTime(file)
            }))
        );
        
        filesWithTime.sort((a, b) => a.time - b.time);
        const zip = new JSZip();
        
        const baseTitle = currentTemplateName || currentData[0].v || "í˜„ì¥ì‚¬ì§„";
        const sampleNumber = currentData[1].v;
        const datePart = getShortDate(currentData[2].v);
        const zipFileName = sampleNumber 
            ? `${baseTitle} ${sampleNumber} ${datePart}`.trim() 
            : `${baseTitle} ${datePart}`.trim();
        const photoBaseName = sampleNumber || "ì‚¬ì§„";
        
        let newestTime = new Date(0);

        for (let i = 0; i < filesWithTime.length; i++) {
            statusText.innerText = `${i+1}/${filesWithTime.length}ê°œ ì²˜ë¦¬ ì¤‘...`;
            const target = filesWithTime[i];
            if (target.time > newestTime) newestTime = target.time;
            
            const blob = await processImage(target.file, target.time);
            
            // ZIP ë‚´ë¶€ íŒŒì¼ ë‚ ì§œë¥¼ ì›ë³¸ ì´¬ì˜ ë‚ ì§œë¡œ ì„¤ì •
            zip.file(`${photoBaseName} (${i+1}).jpg`, blob, {
                date: (target.time && target.time.getTime() > 0) ? target.time : new Date()
            });
        }

        statusText.innerText = 'ì••ì¶• íŒŒì¼ ìƒì„± ì¤‘...';
        const content = await zip.generateAsync({type: "blob"});
        currentZipBlob = content;
        currentZipFileName = `${zipFileName}.zip`;
        
        // Dropbox ì„¤ì • í™•ì¸
        const dropboxData = localStorage.getItem(dropboxKey);
        const dropboxSettings = dropboxData ? JSON.parse(dropboxData) : null;
        const useDropbox = dropboxSettings && dropboxSettings.autoUpload && dropboxAccessToken;
        
        // Dropbox ìë™ ì—…ë¡œë“œ
        if (useDropbox && !dropboxSettings.manualUpload) {
            try {
                statusText.innerText = 'Dropboxì— ì—…ë¡œë“œ ì¤‘... (ì°½ì„ ë‹«ì§€ ë§ˆì„¸ìš”)';
                await uploadToDropbox(content, currentZipFileName, newestTime);
                statusText.innerText = 'âœ… Dropbox ì—…ë¡œë“œ ì™„ë£Œ!';
                document.getElementById('openDropboxBtn').style.display = 'block';
            } catch (err) {
                console.error('Dropbox ì—…ë¡œë“œ ì‹¤íŒ¨:', err);
                statusText.innerText = 'âŒ Dropbox ì‹¤íŒ¨: ' + err.message;
                alert('ë“œë¡­ë°•ìŠ¤ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\në¡œì»¬ ì €ì¥ì„ ì‹œì‘í•©ë‹ˆë‹¤.');
            }
        } 
        // ìˆ˜ë™ ì—…ë¡œë“œ ëª¨ë“œ
        else if (useDropbox && dropboxSettings.manualUpload) {
            statusText.innerText = "ì••ì¶• ì™„ë£Œ! í™•ì¸ í›„ ì—…ë¡œë“œí•˜ì„¸ìš”.";
            document.getElementById('uploadToCloudBtn').style.display = 'block';
            document.getElementById('uploadToCloudBtn').disabled = false;
        } else {
            statusText.innerText = "ë¡œì»¬ ì €ì¥ ì™„ë£Œ!";
        }
        
        // ë¡œì»¬ ì €ì¥
        saveToLocal(content, currentZipFileName);
    });

    async function processImage(file, originalTime) {
        let extractedExif = null;
        try { 
            extractedExif = await exifr.parse(file, { 
                tiff: true, 
                exif: true, 
                gps: true, 
                reviveValues: true 
            }); 
        } catch (e) { 
            console.warn("EXIF ì¶”ì¶œ ì‹¤íŒ¨", e); 
        }

        return new Promise(res => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const originalDataUrl = e.target.result;
                const img = new Image();
                img.src = originalDataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width; 
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    // í‘œ ê·¸ë¦¬ê¸°
                    const scale = tableSize / 100;
                    const rowH = canvas.height * 0.045 * scale;
                    const fontSize = rowH * 0.75;
                    ctx.font = `${fontSize}px Arial`;
                    ctx.textBaseline = 'middle';
                    
                    let maxVWidth = 0;
                    currentData.forEach(d => { 
                        if(ctx.measureText(d.v).width > maxVWidth) maxVWidth = ctx.measureText(d.v).width; 
                    });
                    
                    const keyWidth = ctx.measureText("ê³µì‚¬ëª…ì¼ì").width;
                    const padding = 40 * scale; 
                    const tableW = keyWidth + maxVWidth + (padding * 4);
                    const tableH = rowH * 5;
                    const x = 0; 
                    const y = canvas.height - tableH;

                    ctx.fillStyle = "white"; 
                    ctx.fillRect(x, y, tableW, tableH);
                    ctx.strokeStyle = "black"; 
                    ctx.lineWidth = canvas.width * 0.0015; 
                    ctx.fillStyle = "black";
                    
                    currentData.forEach((item, i) => {
                        const cy = y + (i * rowH);
                        ctx.strokeRect(x, cy, tableW, rowH);
                        const splitX = x + keyWidth + (padding * 2);
                        ctx.beginPath(); 
                        ctx.moveTo(splitX, cy); 
                        ctx.lineTo(splitX, cy+rowH); 
                        ctx.stroke();
                        ctx.fillText(item.k, x + padding, cy + (rowH * 0.5));
                        ctx.fillText(item.v, splitX + padding, cy + (rowH * 0.5));
                    });

                    canvas.toBlob(blob => {
                        const reader2 = new FileReader();
                        reader2.readAsDataURL(blob);
                        reader2.onload = (e2) => {
                            const newDataUrl = e2.target.result;
                            try {
                                // ì›ë³¸ EXIF ë¡œë“œ
                                let originalExifObj = {};
                                try { 
                                    originalExifObj = piexif.load(originalDataUrl); 
                                } catch (err) { 
                                    originalExifObj = { "0th": {}, "Exif": {}, "GPS": {}, "Interop": {}, "1st": {} }; 
                                }
                                
                                // [ì œë¯¸ë‚˜ì´ì˜ í•µì‹¬] ì›ë³¸ ì´¬ì˜ ë‚ ì§œë¥¼ ëª¨ë“  ë‚ ì§œ í•„ë“œì— ë™ê¸°í™”
                                let targetDate = (originalTime && originalTime.getTime() > 0) ? originalTime : new Date();
                                let dateStr = formatDateForExif(targetDate);
                                
                                if (!originalExifObj['Exif']) originalExifObj['Exif'] = {};
                                if (!originalExifObj['0th']) originalExifObj['0th'] = {};
                                
                                originalExifObj['Exif'][piexif.ExifIFD.DateTimeOriginal] = dateStr;
                                originalExifObj['Exif'][piexif.ExifIFD.DateTimeDigitized] = dateStr;
                                originalExifObj['0th'][piexif.ImageIFD.DateTime] = dateStr;

                                // exifrì—ì„œ ì¶”ì¶œí•œ ë©”íƒ€ë°ì´í„° ë³´ê°•
                                if (extractedExif) {
                                    if (extractedExif.Make) {
                                        originalExifObj['0th'][piexif.ImageIFD.Make] = String(extractedExif.Make);
                                    }
                                    if (extractedExif.Model) {
                                        originalExifObj['0th'][piexif.ImageIFD.Model] = String(extractedExif.Model);
                                    }
                                    
                                    // ì¡°ë¦¬ê°œ, ì…”í„°, ISO ë“±
                                    if (extractedExif.FNumber !== undefined) {
                                        originalExifObj['Exif'][piexif.ExifIFD.FNumber] = toRational(extractedExif.FNumber);
                                    }
                                    if (extractedExif.ExposureTime !== undefined) {
                                        originalExifObj['Exif'][piexif.ExifIFD.ExposureTime] = toRational(extractedExif.ExposureTime);
                                    }
                                    if (extractedExif.ISO !== undefined) {
                                        originalExifObj['Exif'][piexif.ExifIFD.ISOSpeedRatings] = extractedExif.ISO;
                                    }
                                    if (extractedExif.FocalLength !== undefined) {
                                        originalExifObj['Exif'][piexif.ExifIFD.FocalLength] = toRational(extractedExif.FocalLength);
                                    }
                                    if (extractedExif.LensModel) {
                                        originalExifObj['Exif'][piexif.ExifIFD.LensModel] = String(extractedExif.LensModel);
                                    }
                                    if (extractedExif.WhiteBalance !== undefined) {
                                        originalExifObj['Exif'][piexif.ExifIFD.WhiteBalance] = extractedExif.WhiteBalance;
                                    }
                                    if (extractedExif.Flash !== undefined) {
                                        originalExifObj['Exif'][piexif.ExifIFD.Flash] = extractedExif.Flash;
                                    }
                                    if (extractedExif.ExposureMode !== undefined) {
                                        originalExifObj['Exif'][piexif.ExifIFD.ExposureMode] = extractedExif.ExposureMode;
                                    }
                                    if (extractedExif.ExposureCompensation !== undefined) {
                                        originalExifObj['Exif'][piexif.ExifIFD.ExposureBiasValue] = toRational(extractedExif.ExposureCompensation);
                                    }
                                    if (extractedExif.MeteringMode !== undefined) {
                                        originalExifObj['Exif'][piexif.ExifIFD.MeteringMode] = extractedExif.MeteringMode;
                                    }
                                    
                                    // GPS ì •ë³´
                                    if (extractedExif.latitude && extractedExif.longitude) {
                                        if (!originalExifObj['GPS']) originalExifObj['GPS'] = {};
                                        originalExifObj['GPS'][piexif.GPSIFD.GPSVersionID] = [2, 2, 0, 0];
                                        originalExifObj['GPS'][piexif.GPSIFD.GPSLatitudeRef] = extractedExif.latitude < 0 ? 'S' : 'N';
                                        originalExifObj['GPS'][piexif.GPSIFD.GPSLatitude] = degToDmsRational(extractedExif.latitude);
                                        originalExifObj['GPS'][piexif.GPSIFD.GPSLongitudeRef] = extractedExif.longitude < 0 ? 'W' : 'E';
                                        originalExifObj['GPS'][piexif.GPSIFD.GPSLongitude] = degToDmsRational(extractedExif.longitude);
                                        
                                        if (extractedExif.GPSAltitude !== undefined) {
                                            originalExifObj['GPS'][piexif.GPSIFD.GPSAltitude] = toRational(Math.abs(extractedExif.GPSAltitude));
                                            originalExifObj['GPS'][piexif.GPSIFD.GPSAltitudeRef] = extractedExif.GPSAltitude < 0 ? 1 : 0;
                                        }
                                    }
                                    
                                    console.log('âœ… EXIF ë©”íƒ€ë°ì´í„° ì™„ì „ ë³´ì¡´:', {
                                        ì¹´ë©”ë¼: extractedExif.Make,
                                        ëª¨ë¸: extractedExif.Model,
                                        ì¡°ë¦¬ê°œ: extractedExif.FNumber,
                                        ì…”í„°: extractedExif.ExposureTime,
                                        ISO: extractedExif.ISO,
                                        ì´ˆì ê±°ë¦¬: extractedExif.FocalLength,
                                        ë Œì¦ˆ: extractedExif.LensModel,
                                        ì´¬ì˜ë‚ ì§œ: targetDate,
                                        GPS: extractedExif.latitude ? 'ìˆìŒ' : 'ì—†ìŒ'
                                    });
                                }
                                
                                const finalDataUrl = piexif.insert(piexif.dump(originalExifObj), newDataUrl);
                                fetch(finalDataUrl).then(r => r.blob()).then(res);
                            } catch (err) { 
                                console.error('ë©”íƒ€ë°ì´í„° ì£¼ì… ì‹¤íŒ¨:', err);
                                res(blob); 
                            }
                        };
                    }, "image/jpeg", 0.95);
                }
            }
        });
    }

    // ========== Dropbox ì—…ë¡œë“œ (ì§„í–‰ë¥  + ìŠ¤ë§ˆíŠ¸ íƒ€ì„ì•„ì›ƒ + ì·¨ì†Œ) ==========
    async function uploadToDropbox(blob, fileName, fileDate) {
        if (!dropboxAccessToken) {
            throw new Error('Dropbox ì—°ê²° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        const fullPath = getDropboxPath(fileName.replace(/[:*?"<>|]/g, ''));
        let arg = { 
            path: fullPath, 
            mode: 'add', 
            autorename: true, 
            mute: false 
        };
        
        // client_modified ì„¤ì • (Dropboxì˜ "ì°ì€ ë‚ ì§œ")
        if (fileDate && fileDate.getTime() > 0) {
            arg.client_modified = fileDate.toISOString().split('.')[0] + 'Z';
        }

        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function() {
                const xhr = new XMLHttpRequest();
                
                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ì·¨ì†Œìš©)
                currentUploadXHR = xhr;
                
                // ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('cancelUploadBtn').style.display = 'block';
                
                // ìŠ¤ë§ˆíŠ¸ íƒ€ì„ì•„ì›ƒ: ì§„í–‰ì´ ë©ˆì¶”ë©´ 30ì´ˆ í›„ ì¤‘ë‹¨
                let lastProgressTime = Date.now();
                let progressCheckInterval = setInterval(() => {
                    if (Date.now() - lastProgressTime > 30000) {
                        clearInterval(progressCheckInterval);
                        xhr.abort();
                        reject(new Error('ì—…ë¡œë“œê°€ 30ì´ˆê°„ ì§„í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'));
                    }
                }, 1000);
                
                xhr.open('POST', 'https://content.dropboxapi.com/2/files/upload');
                xhr.setRequestHeader('Authorization', 'Bearer ' + dropboxAccessToken);
                xhr.setRequestHeader('Content-Type', 'application/octet-stream');
                xhr.setRequestHeader('Dropbox-API-Arg', JSON.stringify(arg).replace(/[\u007f-\uffff]/g, (c) => '\\u' + ('0000' + c.charCodeAt(0).toString(16)).slice(-4)));
                
                // ì§„í–‰ë¥  í‘œì‹œ
                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        lastProgressTime = Date.now(); // ì§„í–‰ ì‹œê°„ ê°±ì‹ 
                        
                        const percent = Math.round((event.loaded / event.total) * 100);
                        const loadedMB = (event.loaded / 1048576).toFixed(1);
                        const totalMB = (event.total / 1048576).toFixed(1);
                        
                        statusText.innerText = 
                            `Dropbox ì—…ë¡œë“œ ì¤‘... ${percent}% (${loadedMB}MB / ${totalMB}MB)`;
                    }
                };
                
                xhr.onload = () => {
                    clearInterval(progressCheckInterval);
                    currentUploadXHR = null;
                    document.getElementById('cancelUploadBtn').style.display = 'none';
                    
                    if (xhr.status >= 200 && xhr.status < 300) {
                        const result = JSON.parse(xhr.responseText);
                        dropboxLastPath = result.path_display;
                        console.log('âœ… Dropbox ì—…ë¡œë“œ ì„±ê³µ:', result.path_display);
                        resolve(result);
                    } else {
                        reject(new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${xhr.status}): ${xhr.responseText}`));
                    }
                };
                
                xhr.onerror = () => {
                    clearInterval(progressCheckInterval);
                    currentUploadXHR = null;
                    document.getElementById('cancelUploadBtn').style.display = 'none';
                    reject(new Error('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€ (iOS PWA ì œí•œ)'));
                };
                
                xhr.onabort = () => {
                    clearInterval(progressCheckInterval);
                    currentUploadXHR = null;
                    document.getElementById('cancelUploadBtn').style.display = 'none';
                    reject(new Error('ì‚¬ìš©ìê°€ ì—…ë¡œë“œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.'));
                };
                
                // ArrayBuffer ì „ì†¡
                xhr.send(reader.result);
            };
            reader.readAsArrayBuffer(blob);
        });
    }

    // ========== ë¡œì»¬ ì €ì¥ ==========
    function saveToLocal(blob, fileName) {
        const link = document.createElement('a'); 
        link.href = URL.createObjectURL(blob); 
        link.download = fileName;
        document.body.appendChild(link); 
        link.click(); 
        document.body.removeChild(link);
        openFilesBtn.style.display = 'block';
    }

    // ========== íŒŒì¼/Dropbox ì—´ê¸° ==========
    function openFilesApp() {
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        
        if (isIOS) {
            window.location.href = 'shareddocuments://';
        } else if (isAndroid) {
            alert('íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œ í´ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }

    function openDropboxFolder() {
        if (dropboxLastPath) {
            const folderPath = dropboxLastPath.substring(0, dropboxLastPath.lastIndexOf('/'));
            window.open(`https://www.dropbox.com/home${folderPath}`, '_blank');
        } else {
            window.open('https://www.dropbox.com/home', '_blank');
        }
    }

    // ========== ì—…ë¡œë“œ ì·¨ì†Œ ==========
    function cancelUpload() {
        if (currentUploadXHR) {
            currentUploadXHR.abort();
            currentUploadXHR = null;
            statusText.innerText = 'ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.getElementById('cancelUploadBtn').style.display = 'none';
        }
    }

    // ========== ìˆ˜ë™ ì—…ë¡œë“œ ==========
    async function manualUploadToCloud() {
        if (!currentZipBlob || !currentZipFileName) {
            alert('ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (!dropboxAccessToken) {
            alert('Dropboxì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\nì„¤ì •ì—ì„œ ì—°ê²° ë° ìë™ ì—…ë¡œë“œë¥¼ í™œì„±í™”í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        try {
            statusText.innerText = 'Dropboxì— ì—…ë¡œë“œ ì¤‘...';
            document.getElementById('uploadToCloudBtn').disabled = true;
            
            // newestTimeì„ ë‹¤ì‹œ ê³„ì‚°í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ í˜„ì¬ ì‹œê°„ ì‚¬ìš©
            await uploadToDropbox(currentZipBlob, currentZipFileName, new Date());
            
            statusText.innerText = 'âœ… Dropbox ì—…ë¡œë“œ ì™„ë£Œ!';
            document.getElementById('uploadToCloudBtn').style.display = 'none';
            document.getElementById('openDropboxBtn').style.display = 'block';
        } catch (error) {
            console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            statusText.innerText = 'ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message;
            alert('ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n' + error.message);
            document.getElementById('uploadToCloudBtn').disabled = false;
        }
    }

    // ========== í™”ë©´ ì „í™˜ ==========
    function showSettings() { 
        document.getElementById('mainScreen').classList.remove('active'); 
        document.getElementById('settingsScreen').classList.add('active'); 
    }
    
    function showMain() { 
        document.getElementById('settingsScreen').classList.remove('active'); 
        document.getElementById('mainScreen').classList.add('active'); 
    }

    // ========== í…Œë§ˆ ==========
    function toggleTheme() { 
        if (document.getElementById('themeToggle').checked) { 
            document.body.classList.remove('light-mode'); 
            localStorage.setItem(themeKey, 'dark'); 
        } else { 
            document.body.classList.add('light-mode'); 
            localStorage.setItem(themeKey, 'light'); 
        } 
    }
    
    function loadTheme() { 
        if ((localStorage.getItem(themeKey) || 'dark') === 'light') { 
            document.body.classList.add('light-mode'); 
            document.getElementById('themeToggle').checked = false; 
        } else { 
            document.getElementById('themeToggle').checked = true; 
        } 
    }

    // ========== í‘œ í¬ê¸° ==========
    function updateTableSize(v) { 
        tableSize = parseInt(v); 
        document.getElementById('tableSizeValue').textContent = v + '%'; 
        localStorage.setItem(tableSizeKey, tableSize); 
    }
    
    function loadTableSize() { 
        const s = localStorage.getItem(tableSizeKey); 
        if (s) { 
            tableSize = parseInt(s); 
            document.getElementById('tableSizeSlider').value = tableSize; 
            document.getElementById('tableSizeValue').textContent = tableSize + '%'; 
        } 
    }

    // ========== Dropbox í´ë” ==========
    function getDropboxPath(fileName) {
        let folderPath = localStorage.getItem('dropbox_folder_path') || '/í˜„ì¥ì‚¬ì§„';
        
        if (!folderPath.startsWith('/')) {
            folderPath = '/' + folderPath;
        }
        
        if (localStorage.getItem('dropbox_date_folder') !== 'false') {
            const match = currentData[2].v.match(/(\d{4})ë…„ (\d{2})ì›”/);
            if (match) {
                folderPath += `/${match[1]}/${match[2]}`;
            }
        }
        
        if (folderPath.endsWith('/')) {
            folderPath = folderPath.slice(0, -1);
        }
        
        return `${folderPath}/${fileName}`;
    }
    
    function saveDropboxFolder() { 
        localStorage.setItem('dropbox_folder_path', document.getElementById('dropboxFolderPath').value.trim() || '/í˜„ì¥ì‚¬ì§„'); 
        localStorage.setItem('dropbox_date_folder', document.getElementById('dropboxDateFolder').checked); 
    }
    
    function loadDropboxFolder() { 
        document.getElementById('dropboxFolderPath').value = localStorage.getItem('dropbox_folder_path') || '/í˜„ì¥ì‚¬ì§„'; 
        document.getElementById('dropboxDateFolder').checked = localStorage.getItem('dropbox_date_folder') !== 'false'; 
    }
    
    function toggleDropboxSettings() { 
        const s = JSON.parse(localStorage.getItem(dropboxKey) || '{}'); 
        s.autoUpload = document.getElementById('dropboxAutoUpload').checked; 
        s.manualUpload = document.getElementById('dropboxManualUpload').checked; 
        localStorage.setItem(dropboxKey, JSON.stringify(s)); 
    }

    // ========== í…œí”Œë¦¿ ê´€ë¦¬ ==========
    function renderFields() { 
        const c = document.getElementById('tableFields'); 
        c.innerHTML = ''; 
        currentData.forEach((item, i) => { 
            const row = document.createElement('div'); 
            row.className = 'row'; 
            if (item.k === "ì¼ì") { 
                row.innerHTML = `<input type="text" class="col-key" value="${item.k}" oninput="currentData[${i}].k=this.value"><input type="date" value="${koreanToISO(item.v)}" onchange="updateDateField(${i}, this.value)">`; 
            } else { 
                row.innerHTML = `<input type="text" class="col-key" value="${item.k}" oninput="currentData[${i}].k=this.value"><div class="input-wrapper"><input type="text" class="input-with-clear" value="${item.v}" oninput="currentData[${i}].v=this.value; toggleFieldClearBtn(${i})"><button class="clear-btn" id="clearValue${i}" onclick="clearFieldInput(${i})">âœ•</button></div>`; 
            } 
            c.appendChild(row); 
            if (item.k !== "ì¼ì") setTimeout(() => toggleFieldClearBtn(i), 0); 
        }); 
    }
    
    function toggleFieldClearBtn(i) { 
        const btn = document.getElementById(`clearValue${i}`); 
        if (btn) btn.style.display = currentData[i].v ? 'flex' : 'none'; 
    }
    
    function clearFieldInput(i) { 
        currentData[i].v = ''; 
        renderFields(); 
    }
    
    function updateDateField(i, v) { 
        if (v) { 
            const [y, m, d] = v.split('-'); 
            currentData[i].v = `${y}ë…„ ${m}ì›” ${d}ì¼`; 
        } 
    }
    
    function koreanToISO(k) { 
        const m = k.match(/(\d{4})ë…„ (\d{2})ì›” (\d{2})ì¼/); 
        return m ? `${m[1]}-${m[2]}-${m[3]}` : ''; 
    }
    
    function getShortDate(s) { 
        const m = s.match(/(\d{4})ë…„ (\d{2})ì›” (\d{2})ì¼/); 
        return m ? (m[1].substring(2) + m[2] + m[3]) : "000000"; 
    }
    
    function updateTmplList() { 
        const s = document.getElementById('templateList'); 
        const t = JSON.parse(localStorage.getItem(storageKey) || '{}'); 
        s.innerHTML = '<option value="">í…œí”Œë¦¿ ì„ íƒ</option>'; 
        for(let n in t) s.innerHTML += `<option value="${n}">${n}</option>`; 
    }
    
    function saveTemplate() { 
        const n = document.getElementById('newTemplateName').value.trim(); 
        if(!n) return alert("í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"); 
        let t = JSON.parse(localStorage.getItem(storageKey) || '{}'); 
        t[n] = JSON.parse(JSON.stringify(currentData)); 
        localStorage.setItem(storageKey, JSON.stringify(t)); 
        currentTemplateName = n;
        document.getElementById('templateList').value = n;
        updateTmplList(); 
        alert("í…œí”Œë¦¿ ì €ì¥ ì™„ë£Œ!"); 
    }
    
    function loadTemplate() { 
        const n = document.getElementById('templateList').value; 
        const nameInput = document.getElementById('newTemplateName');
        
        if(!n) { 
            currentTemplateName = ""; 
            nameInput.value = "";
            return; 
        }
        
        const t = JSON.parse(localStorage.getItem(storageKey) || '{}'); 
        if(t[n]) { 
            currentData = JSON.parse(JSON.stringify(t[n]));
            currentData[2].v = dateStr; 
            currentTemplateName = n;
            nameInput.value = n;
            renderFields(); 
        } 
    }
    
    function deleteTemplate() {
        const n = document.getElementById('templateList').value;
        if (!n) return alert("ì‚­ì œí•  í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”");
        if (!confirm(`"${n}" í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        
        let t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        delete t[n];
        localStorage.setItem(storageKey, JSON.stringify(t));
        
        if (currentTemplateName === n) {
            currentTemplateName = "";
            document.getElementById('newTemplateName').value = "";
        }
        
        updateTmplList();
        alert("í…œí”Œë¦¿ ì‚­ì œ ì™„ë£Œ!");
    }
    
    function toggleClearBtn() {
        const input = document.getElementById('newTemplateName');
        const btn = document.getElementById('clearNameBtn');
        btn.style.display = input.value ? 'flex' : 'none';
    }
    
    function clearTemplateName() {
        document.getElementById('newTemplateName').value = '';
        toggleClearBtn();
    }

    // ========== í…œí”Œë¦¿ ë°±ì—…/ë³µì› ==========
    function exportTemplates() {
        const t = localStorage.getItem(storageKey);
        if (!t || t === '{}') {
            alert('ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const blob = new Blob([t], {type: 'application/json'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `templates_${new Date().getTime()}.json`;
        link.click();
        alert('í…œí”Œë¦¿ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤!');
    }
    
    function importTemplates(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                const existing = JSON.parse(localStorage.getItem(storageKey) || '{}');
                const merged = {...existing, ...imported};
                localStorage.setItem(storageKey, JSON.stringify(merged));
                updateTmplList();
                alert('í…œí”Œë¦¿ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!');
            } catch (err) {
                alert('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    // ========== Dropbox OAuth ==========
    async function connectDropbox() { 
        const v = btoa(String.fromCharCode(...window.crypto.getRandomValues(new Uint8Array(32))))
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
        localStorage.setItem('dropbox_code_verifier', v);
        
        const h = await window.crypto.subtle.digest('SHA-256', new TextEncoder().encode(v));
        const c = btoa(String.fromCharCode(...new Uint8Array(h)))
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
        
        window.location.href = `https://www.dropbox.com/oauth2/authorize?client_id=${DROPBOX_CLIENT_ID}&redirect_uri=${encodeURIComponent(DROPBOX_REDIRECT_URI)}&response_type=code&code_challenge=${c}&code_challenge_method=S256&token_access_type=offline`; 
    }
    
    async function handleDropboxCallback() { 
        const code = new URLSearchParams(window.location.search).get('code');
        const v = localStorage.getItem('dropbox_code_verifier');
        
        if (code && v) {
            const r = await fetch('https://api.dropboxapi.com/oauth2/token', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
                body: new URLSearchParams({ 
                    code: code, 
                    grant_type: 'authorization_code', 
                    client_id: DROPBOX_CLIENT_ID, 
                    code_verifier: v, 
                    redirect_uri: DROPBOX_REDIRECT_URI 
                }) 
            });
            
            const d = await r.json();
            
            const ar = await fetch('https://api.dropboxapi.com/2/users/get_current_account', { 
                method: 'POST', 
                headers: { 'Authorization': `Bearer ${d.access_token}` } 
            });
            const ad = await ar.json();
            
            localStorage.setItem(dropboxKey, JSON.stringify({ 
                access_token: d.access_token, 
                refresh_token: d.refresh_token, 
                expires_at: Date.now() + (d.expires_in * 1000), 
                email: ad.email, 
                autoUpload: false, 
                manualUpload: false 
            }));
            
            window.history.replaceState({}, document.title, window.location.pathname);
            await loadDropboxToken(); 
            await updateDropboxStatus();
        }
    }
    
    async function loadDropboxToken() {
        const s = localStorage.getItem(dropboxKey); 
        if (!s) return false;
        
        const d = JSON.parse(s);
        
        // í† í° ê°±ì‹  (ë§Œë£Œ 10ë¶„ ì „)
        if (Date.now() > (d.expires_at - 600000) && d.refresh_token) {
            const r = await fetch('https://api.dropboxapi.com/oauth2/token', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
                body: new URLSearchParams({ 
                    grant_type: 'refresh_token', 
                    refresh_token: d.refresh_token, 
                    client_id: DROPBOX_CLIENT_ID 
                }) 
            });
            
            const nd = await r.json();
            d.access_token = nd.access_token; 
            d.expires_at = Date.now() + (nd.expires_in * 1000);
            localStorage.setItem(dropboxKey, JSON.stringify(d));
        }
        
        dropboxAccessToken = d.access_token;
        dropboxRefreshToken = d.refresh_token;
        
        document.getElementById('dropboxAutoUpload').checked = d.autoUpload || false;
        document.getElementById('dropboxManualUpload').checked = d.manualUpload || false;
        
        return true;
    }
    
    async function updateDropboxStatus() {
        const s = localStorage.getItem(dropboxKey);
        
        if (dropboxAccessToken && s) {
            const d = JSON.parse(s);
            document.getElementById('dropboxStatus').classList.add('connected');
            document.getElementById('dropboxIndicator').classList.add('connected');
            document.getElementById('dropboxEmail').textContent = d.email || 'ì—°ê²°ë¨';
            document.getElementById('dropboxConnectBtn').style.display = 'none';
            document.getElementById('dropboxDisconnectBtn').style.display = 'block';
        } else {
            document.getElementById('dropboxStatus').classList.remove('connected');
            document.getElementById('dropboxIndicator').classList.remove('connected');
            document.getElementById('dropboxEmail').textContent = 'ì—°ê²°ë˜ì§€ ì•ŠìŒ';
            document.getElementById('dropboxConnectBtn').style.display = 'block';
            document.getElementById('dropboxDisconnectBtn').style.display = 'none';
        }
    }
    
    function disconnectDropbox() {
        if (!confirm('Dropbox ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        localStorage.removeItem(dropboxKey);
        dropboxAccessToken = null;
        dropboxRefreshToken = null;
        
        updateDropboxStatus();
        alert('Dropbox ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ========== ì•± ì—…ë°ì´íŠ¸ ==========
    function updateApp() {
        if (!confirm('ìºì‹œë¥¼ ì‚­ì œí•˜ê³  ìµœì‹  ë²„ì „ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        if ('caches' in window) {
            caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
            });
        }
        
        alert('ìºì‹œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
        window.location.reload(true);
    }

    // ========== ì´ˆê¸°í™” ==========
    window.onload = async () => { 
        renderFields(); 
        updateTmplList(); 
        loadTheme(); 
        loadTableSize(); 
        loadDropboxFolder();
        
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        
        if (isAndroid) {
            document.getElementById('openFilesBtn').textContent = 'ğŸ“‚ ë‹¤ìš´ë¡œë“œ í´ë” í™•ì¸';
        } else if (isIOS) {
            document.getElementById('openFilesBtn').textContent = 'ğŸ“‚ íŒŒì¼ ì•± ì—´ê¸°';
        }
        
        if (window.location.search.includes('code=')) {
            await handleDropboxCallback();
        }
        
        await loadDropboxToken(); 
        await updateDropboxStatus();
    };
</script>
</body>
</html>
