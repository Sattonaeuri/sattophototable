<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í˜„ì¥ ì‚¬ì§„ Pro (ë‚ ì§œ ì™„ë²½ ë™ê¸°í™”)</title>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/piexifjs/1.0.6/piexif.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #e5e5ea;
            --text-tertiary: #a1a1a6;
            --border-color: #3a3a3c;
            --shadow: rgba(0,0,0,0.5);
        }
        
        body.light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f2f2f7;
            --bg-tertiary: #ffffff;
            --text-primary: #000000;
            --text-secondary: #1c1c1e;
            --text-tertiary: #8e8e93;
            --border-color: #d1d1d6;
            --shadow: rgba(0,0,0,0.1);
        }
        
        body { font-family: -apple-system, sans-serif; padding: 20px; background: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; margin: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 5px; }
        .header h1 { margin: 0; font-size: 24px; color: var(--text-primary); }
        .settings-btn { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-primary); }
        .back-btn { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 16px; font-size: 16px; cursor: pointer; color: var(--text-primary); display: flex; align-items: center; gap: 5px; }
        .card { background: var(--bg-secondary); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px var(--shadow); box-sizing: border-box; border: 1px solid var(--border-color); }
        h3 { margin: 0 0 12px 0; font-size: 16px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; color: var(--text-secondary); }
        .row { display: flex; gap: 10px; margin-bottom: 8px; align-items: stretch; width: 100%; }
        .col-key { width: 65px; flex: none !important; font-weight: bold; background: var(--bg-tertiary); color: var(--text-tertiary); border: 1px solid var(--border-color); padding: 12px 5px; border-radius: 8px; text-align: center; font-size: 13px; box-sizing: border-box; }
        input, select { flex: 1; min-width: 0; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 15px; background: var(--bg-tertiary); color: var(--text-primary); box-sizing: border-box; }
        .input-wrapper { position: relative; flex: 1; display: flex; align-items: center; min-width: 0; }
        .input-wrapper input { flex: 1; min-width: 0; }
        .input-with-clear { padding-right: 40px !important; }
        .clear-btn { position: absolute; right: 8px; background: #8e8e93; border: none; border-radius: 50%; width: 24px; height: 24px; color: white; font-size: 14px; cursor: pointer; display: none; align-items: center; justify-content: center; line-height: 1; }
        input[type="date"] { color-scheme: light dark; -webkit-appearance: none; }
        body.light-mode input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0); }
        body:not(.light-mode) input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        button { padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #0a84ff; color: white; width: 100%; margin-top: 10px; }
        .btn-green { background: #30d158; color: white; width: 100%; margin-top: 10px; }
        .btn-red { background: #ff453a; color: white; width: 70px; font-size: 13px; flex-shrink: 0; }
        .btn-gray { background: #8e8e93; color: white; width: 70px; font-size: 13px; flex-shrink: 0; }
        .btn-orange { background: #ff9f0a; color: white; width: 100%; margin-top: 10px; }
        #status { text-align: center; margin-top: 15px; font-weight: 600; color: #0a84ff; word-break: keep-all;}
        #openFilesBtn { display: none; }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 15px; }
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #8e8e93; transition: .3s; border-radius: 31px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: #0a84ff; }
        input:checked + .slider:before { transform: translateX(20px); }
        .screen { display: none; }
        .screen.active { display: block; }
    </style>
</head>
<body>

<div id="mainScreen" class="screen active">
    <div class="header">
        <h1>í˜„ì¥ ì‚¬ì§„ Pro</h1>
        <button class="settings-btn" onclick="showSettings()">âš™ï¸</button>
    </div>

    <div class="card">
        <h3>ğŸ“‹ í‘œ ë‚´ìš© ì…ë ¥</h3>
        <div id="tableFields"></div>
    </div>

    <div class="card">
        <h3>ğŸ’¾ í…œí”Œë¦¿ ê´€ë¦¬</h3>
        <div class="row">
            <select id="templateList" onchange="loadTemplate()"><option value="">í…œí”Œë¦¿ ì„ íƒ</option></select>
            <button class="btn-red" onclick="deleteTemplate()">ì‚­ì œ</button>
        </div>
        <div class="row">
            <div class="input-wrapper">
                <input type="text" id="newTemplateName" class="input-with-clear" placeholder="ìƒˆ ì´ë¦„" oninput="toggleClearBtn()">
                <button class="clear-btn" id="clearNameBtn" onclick="clearTemplateName()">âœ•</button>
            </div>
            <button class="btn-gray" onclick="saveTemplate()">ì €ì¥</button>
        </div>
    </div>

    <div class="card">
        <input type="file" id="imageInput" multiple accept="image/jpeg,image/jpg,image/heic,image/heif" style="display: none;">
        <button class="btn-blue" onclick="document.getElementById('imageInput').click()">ğŸ“¸ ì‚¬ì§„ ì„ íƒ & ì‘ì—… ì‹œì‘</button>
        <div id="status">ëŒ€ê¸° ì¤‘...</div>
        <button id="openFilesBtn" class="btn-green" onclick="openFilesApp()">ğŸ“‚ ê²°ê³¼ í™•ì¸</button>
    </div>

    <div class="card">
        <h3>ğŸ’¾ ë°±ì—… & ë³µì›</h3>
        <button class="btn-blue" onclick="exportTemplates()">ğŸ“¤ ë‚´ë³´ë‚´ê¸° (JSON)</button>
        <input type="file" id="importInput" accept="application/json" style="display: none;" onchange="importTemplates(event)">
        <button class="btn-green" onclick="document.getElementById('importInput').click()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸° (JSON)</button>
    </div>
</div>

<div id="settingsScreen" class="screen">
    <div class="header">
        <button class="back-btn" onclick="showMain()">â† ë’¤ë¡œê°€ê¸°</button>
        <h1>ì„¤ì •</h1>
    </div>

    <div class="card">
        <h3>ğŸ¨ í…Œë§ˆ ì„¤ì •</h3>
        <div class="toggle-row">
            <span class="toggle-label">ë‹¤í¬ ëª¨ë“œ</span>
            <label class="switch">
                <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“ í‘œ í¬ê¸° ì„¤ì •</h3>
        <div style="padding: 10px 0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span id="tableSizeValue" style="color: #0a84ff; font-weight: bold;">100%</span>
            </div>
            <input type="range" id="tableSizeSlider" min="50" max="150" value="100" oninput="updateTableSize(this.value)" style="width: 100%;">
        </div>
    </div>

    <div class="card">
        <h3>ğŸ”„ ì•± ì—…ë°ì´íŠ¸</h3>
        <button class="btn-orange" onclick="updateApp()">ğŸ”„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸</button>
    </div>
</div>

<script>
    const storageKey = 'photo_pro_v8_final';
    const themeKey = 'photo_pro_theme';
    const tableSizeKey = 'photo_pro_table_size';
    
    let currentZipBlob = null;
    let currentZipFileName = null;
    let tableSize = 100; 
    const statusText = document.getElementById('status');
    const openFilesBtn = document.getElementById('openFilesBtn');
    const today = new Date();
    const dateStr = `${today.getFullYear()}ë…„ ${String(today.getMonth() + 1).padStart(2, '0')}ì›” ${String(today.getDate()).padStart(2, '0')}ì¼`;
    
    let currentTemplateName = "";
    let currentData = [
        {k: "ê³µì‚¬ëª…", v: ""}, {k: "ì‹œë£Œë²ˆí˜¸", v: ""},
        {k: "ì¼ì", v: dateStr}, {k: "ì±„ì·¨êµ¬ë¶„", v: ""}, {k: "ì¡°ì‚¬ì", v: ""}
    ];

    // UI ì œì–´
    function showSettings() { document.getElementById('mainScreen').classList.remove('active'); document.getElementById('settingsScreen').classList.add('active'); }
    function showMain() { document.getElementById('settingsScreen').classList.remove('active'); document.getElementById('mainScreen').classList.add('active'); }
    
    function renderFields() { 
        const c = document.getElementById('tableFields'); 
        c.innerHTML = ''; 
        currentData.forEach((item, i) => { 
            const row = document.createElement('div'); 
            row.className = 'row'; 
            if (item.k === "ì¼ì") { 
                row.innerHTML = `<input type="text" class="col-key" value="${item.k}" oninput="currentData[${i}].k=this.value"><input type="date" value="${koreanToISO(item.v)}" onchange="updateDateField(${i}, this.value)">`; 
            } else { 
                row.innerHTML = `<input type="text" class="col-key" value="${item.k}" oninput="currentData[${i}].k=this.value"><div class="input-wrapper"><input type="text" class="input-with-clear" value="${item.v}" oninput="currentData[${i}].v=this.value; toggleFieldClearBtn(${i})"><button class="clear-btn" id="clearValue${i}" onclick="clearFieldInput(${i})">âœ•</button></div>`; 
            } 
            c.appendChild(row); 
            if (item.k !== "ì¼ì") setTimeout(() => toggleFieldClearBtn(i), 0); 
        }); 
    }

    function toggleFieldClearBtn(i) { const btn = document.getElementById(`clearValue${i}`); if (btn) btn.style.display = currentData[i].v ? 'flex' : 'none'; }
    function clearFieldInput(i) { currentData[i].v = ''; renderFields(); }
    function clearTemplateName() { document.getElementById('newTemplateName').value = ''; toggleClearBtn(); }
    function toggleClearBtn() { const input = document.getElementById('newTemplateName'); document.getElementById('clearNameBtn').style.display = input.value ? 'flex' : 'none'; }
    function updateDateField(i, v) { if (v) { const [y, m, d] = v.split('-'); currentData[i].v = `${y}ë…„ ${m}ì›” ${d}ì¼`; } }
    function koreanToISO(k) { const m = k.match(/(\d{4})ë…„ (\d{2})ì›” (\d{2})ì¼/); return m ? `${m[1]}-${m[2]}-${m[3]}` : ''; }
    function getShortDate(s) { const m = s.match(/(\d{4})ë…„ (\d{2})ì›” (\d{2})ì¼/); return m ? (m[1].substring(2) + m[2] + m[3]) : "000000"; }

    // í…œí”Œë¦¿ ê´€ë¦¬
    function updateTmplList() { const s = document.getElementById('templateList'); const t = JSON.parse(localStorage.getItem(storageKey) || '{}'); s.innerHTML = '<option value="">í…œí”Œë¦¿ ì„ íƒ</option>'; for(let n in t) s.innerHTML += `<option value="${n}">${n}</option>`; }
    function saveTemplate() { 
        const name = document.getElementById('newTemplateName').value; 
        if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); 
        let t = JSON.parse(localStorage.getItem(storageKey) || '{}'); 
        t[name] = JSON.parse(JSON.stringify(currentData)); 
        localStorage.setItem(storageKey, JSON.stringify(t)); 
        updateTmplList(); alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
    }
    function loadTemplate() { 
        const n = document.getElementById('templateList').value; 
        if(!n) return;
        const t = JSON.parse(localStorage.getItem(storageKey) || '{}'); 
        if(t[n]) { currentData = t[n]; currentData[2].v = dateStr; currentTemplateName = n; document.getElementById('newTemplateName').value = n; renderFields(); } 
    }
    function deleteTemplate() { 
        const n = document.getElementById('templateList').value; 
        if(!n || !confirm("ì‚­ì œí• ê¹Œìš”?")) return; 
        let t = JSON.parse(localStorage.getItem(storageKey) || '{}'); 
        delete t[n]; localStorage.setItem(storageKey, JSON.stringify(t)); updateTmplList(); 
    }
    function exportTemplates() { const t = localStorage.getItem(storageKey); if (!t) return; const blob = new Blob([t], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = "templates.json"; a.click(); }
    function importTemplates(e) { const file = e.target.files[0]; const r = new FileReader(); r.onload = (e) => { const d = JSON.parse(e.target.result); const ex = JSON.parse(localStorage.getItem(storageKey) || '{}'); localStorage.setItem(storageKey, JSON.stringify({...ex, ...d})); updateTmplList(); alert('ì™„ë£Œ!'); }; r.readAsText(file); }

    // ì´ë¯¸ì§€ ë° EXIF ì²˜ë¦¬
    function formatDateForExif(date) {
        const d = (date instanceof Date) ? date : new Date(date);
        const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0');
        const h = String(d.getHours()).padStart(2, '0'), min = String(d.getMinutes()).padStart(2, '0'), s = String(d.getSeconds()).padStart(2, '0');
        return `${y}:${m}:${day} ${h}:${min}:${s}`;
    }

    async function getExifDateTime(file) {
        try {
            const metadata = await exifr.parse(file, {pick: ['DateTimeOriginal', 'CreateDate']});
            return (metadata && (metadata.DateTimeOriginal || metadata.CreateDate)) ? new Date(metadata.DateTimeOriginal || metadata.CreateDate) : new Date(0);
        } catch (err) { return new Date(0); }
    }

    function degToDmsRational(d) { const abs = Math.abs(d); const deg = Math.floor(abs); const minF = (abs - deg) * 60; const min = Math.floor(minF); const sec = Math.round((minF - min) * 60 * 10000); return [[deg, 1], [min, 1], [sec, 10000]]; }

    async function processImage(file) {
        let extractedExif = null;
        try { extractedExif = await exifr.parse(file, { tiff: true, exif: true, gps: true, reviveValues: true }); } catch (e) {}

        return new Promise(res => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width; canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    const scale = tableSize / 100;
                    const rowH = canvas.height * 0.045 * scale;
                    const fontSize = rowH * 0.75;
                    ctx.font = `${fontSize}px Arial`;
                    ctx.textBaseline = 'middle';
                    let maxVWidth = 0;
                    currentData.forEach(d => { if(ctx.measureText(d.v).width > maxVWidth) maxVWidth = ctx.measureText(d.v).width; });
                    const keyWidth = ctx.measureText("ê³µì‚¬ëª…ì¼ì").width;
                    const padding = 40 * scale; 
                    const tableW = keyWidth + maxVWidth + (padding * 4);
                    const tableH = rowH * 5;
                    const x = 0, y = canvas.height - tableH;

                    ctx.fillStyle = "white"; ctx.fillRect(x, y, tableW, tableH);
                    ctx.strokeStyle = "black"; ctx.lineWidth = canvas.width * 0.0015; ctx.fillStyle = "black";
                    currentData.forEach((item, i) => {
                        const cy = y + (i * rowH);
                        ctx.strokeRect(x, cy, tableW, rowH);
                        const splitX = x + keyWidth + (padding * 2);
                        ctx.beginPath(); ctx.moveTo(splitX, cy); ctx.lineTo(splitX, cy+rowH); ctx.stroke();
                        ctx.fillText(item.k, x + padding, cy + (rowH * 0.5));
                        ctx.fillText(item.v, splitX + padding, cy + (rowH * 0.5));
                    });

                    canvas.toBlob(blob => {
                        const reader2 = new FileReader();
                        reader2.readAsDataURL(blob);
                        reader2.onload = (e2) => {
                            try {
                                const zeroth = {}, exif = {}, gps = {};
                                if (extractedExif) {
                                    zeroth[piexif.ImageIFD.Make] = String(extractedExif.Make || "Camera");
                                    zeroth[piexif.ImageIFD.Model] = String(extractedExif.Model || "Phone");
                                    let targetDate = extractedExif.DateTimeOriginal || extractedExif.CreateDate || new Date();
                                    let exifDateStr = formatDateForExif(targetDate);
                                    
                                    exif[piexif.ExifIFD.DateTimeOriginal] = exifDateStr;
                                    exif[piexif.ExifIFD.DateTimeDigitized] = exifDateStr;
                                    zeroth[piexif.ImageIFD.DateTime] = exifDateStr; // ë‚´ë¶€ ë©”íƒ€ë°ì´í„° ìˆ˜ì •í•œ ë‚ ì§œ

                                    if (extractedExif.latitude && extractedExif.longitude) {
                                        gps[piexif.GPSIFD.GPSVersionID] = [2, 2, 0, 0];
                                        gps[piexif.GPSIFD.GPSLatitudeRef] = extractedExif.latitude < 0 ? 'S' : 'N';
                                        gps[piexif.GPSIFD.GPSLatitude] = degToDmsRational(extractedExif.latitude);
                                        gps[piexif.GPSIFD.GPSLongitudeRef] = extractedExif.longitude < 0 ? 'W' : 'E';
                                        gps[piexif.GPSIFD.GPSLongitude] = degToDmsRational(extractedExif.longitude);
                                    }
                                }
                                const exifObj = { "0th": zeroth, "Exif": exif, "GPS": gps };
                                const finalDataUrl = piexif.insert(piexif.dump(exifObj), e2.target.result);
                                fetch(finalDataUrl).then(r => r.blob()).then(res);
                            } catch (err) { res(blob); }
                        };
                    }, "image/jpeg", 0.95);
                }
            }
        });
    }

    // ë©”ì¸ ì‘ì—… í•¸ë“¤ëŸ¬
    document.getElementById('imageInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        
        statusText.innerText = 'ì‚¬ì§„ ë¶„ì„ ë° ì •ë ¬ ì¤‘...';
        
        // 1. ë‚ ì§œ ì¶”ì¶œ ë° ì´¬ì˜ ì‹œê°„ìˆœ ì •ë ¬
        const filesWithTime = await Promise.all(files.map(async (file) => {
            const time = await getExifDateTime(file);
            return { file, time };
        }));
        filesWithTime.sort((a, b) => a.time - b.time);
        
        const zip = new JSZip();
        const baseTitle = currentTemplateName || currentData[0].v || "í˜„ì¥ì‚¬ì§„";
        const photoBaseName = currentData[1].v || "ì‚¬ì§„"; // ì‹œë£Œë²ˆí˜¸ë¥¼ íŒŒì¼ëª…ìœ¼ë¡œ ì‚¬ìš©
        const datePart = getShortDate(currentData[2].v);
        
        // 2. ì´ë¯¸ì§€ ì²˜ë¦¬ ë£¨í”„
        for (let i = 0; i < filesWithTime.length; i++) {
            statusText.innerText = `${i+1}/${filesWithTime.length}ê°œ ë³€í™˜ ì¤‘...`;
            
            const targetData = filesWithTime[i];
            const blob = await processImage(targetData.file);
            
            // [í•µì‹¬] ZIP ë‚´ë¶€ì˜ íŒŒì¼ ìˆ˜ì • ë‚ ì§œë¥¼ ì´¬ì˜ ì‹œê°ìœ¼ë¡œ ê°•ì œ ê³ ì •
            const fileDate = (targetData.time && targetData.time.getTime() > 0) ? targetData.time : new Date();
            
            zip.file(`${photoBaseName} (${i+1}).jpg`, blob, {
                date: fileDate
            });
        }
        
        statusText.innerText = 'ì••ì¶• íŒŒì¼ ìƒì„± ì¤‘...';
        const content = await zip.generateAsync({type: "blob"});
        currentZipBlob = content;
        currentZipFileName = `${baseTitle}_${datePart}.zip`;
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = currentZipFileName;
        link.click();
        
        statusText.innerText = "ëª¨ë“  ì‘ì—… ì™„ë£Œ!";
        openFilesBtn.style.display = 'block';
    });

    function updateTableSize(v) { tableSize = parseInt(v); document.getElementById('tableSizeValue').textContent = v + '%'; localStorage.setItem(tableSizeKey, tableSize); }
    function loadTableSize() { const s = localStorage.getItem(tableSizeKey); if (s) { tableSize = parseInt(s); document.getElementById('tableSizeSlider').value = tableSize; document.getElementById('tableSizeValue').textContent = tableSize + '%'; } }
    function loadTheme() { if ((localStorage.getItem(themeKey) || 'dark') === 'light') { document.body.classList.add('light-mode'); document.getElementById('themeToggle').checked = false; } else { document.getElementById('themeToggle').checked = true; } }
    function toggleTheme() { if (document.getElementById('themeToggle').checked) { document.body.classList.remove('light-mode'); localStorage.setItem(themeKey, 'dark'); } else { document.body.classList.add('light-mode'); localStorage.setItem(themeKey, 'light'); } }
    function updateApp() { if (confirm('ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) window.location.reload(true); }

    window.onload = () => { renderFields(); updateTmplList(); loadTheme(); loadTableSize(); };
</script>
</body>
</html>
