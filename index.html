<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>현장 사진 메이커 Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f2f2f7; color: #1c1c1e; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h3 { margin: 0 0 12px 0; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .col-key { width: 85px; flex: none !important; font-weight: bold; background: #f9f9f9; border: 1px solid #ddd; padding: 10px; border-radius: 6px; }
        input, select { flex: 1; padding: 12px; border: 1px solid #d1d1d6; border-radius: 8px; font-size: 15px; }
        button { padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #007aff; color: white; width: 100%; margin-top: 10px; }
        .btn-red { background: #ff3b30; color: white; width: 70px; font-size: 13px; }
        .btn-gray { background: #8e8e93; color: white; width: 70px; font-size: 13px; }
        #status { text-align: center; margin-top: 15px; font-weight: 600; color: #007aff; }
    </style>
</head>
<body>

<div class="card">
    <h3>📋 표 내용 입력</h3>
    <div id="tableFields"></div>
</div>

<div class="card">
    <h3>💾 템플릿 관리</h3>
    <div class="row">
        <select id="templateList" onchange="loadTemplate()"><option value="">템플릿 선택</option></select>
        <button class="btn-red" onclick="deleteTemplate()">삭제</button>
    </div>
    <div class="row">
        <input type="text" id="newTemplateName" placeholder="새 이름">
        <button class="btn-gray" onclick="saveTemplate()">저장</button>
    </div>
</div>

<div class="card">
    <input type="file" id="imageInput" multiple accept="image/jpeg" style="display: none;">
    <button class="btn-blue" onclick="document.getElementById('imageInput').click()">📸 사진 선택 & 일괄 작업 시작</button>
    <div id="status">대기 중...</div>
</div>

<script>
    const storageKey = 'photo_pro_v5_final';
    const statusText = document.getElementById('status');
    const today = new Date();
    const dateStr = `${today.getFullYear()}년 ${String(today.getMonth() + 1).padStart(2, '0')}월 ${String(today.getDate()).padStart(2, '0')}일`;

    let currentData = [
        {k: "공사명", v: ""}, {k: "시료번호", v: ""},
        {k: "일자", v: dateStr}, {k: "채취구분", v: ""}, {k: "조사자", v: ""}
    ];

    function renderFields() {
        const container = document.getElementById('tableFields');
        container.innerHTML = '';
        currentData.forEach((item, i) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.innerHTML = `<div class="col-key">${item.k}</div>
                             <input type="text" value="${item.v}" oninput="currentData[${i}].v=this.value">`;
            container.appendChild(row);
        });
    }

    function getShortDate(str) {
        const match = str.match(/(\d{4})년 (\d{2})월 (\d{2})일/);
        return match ? (match[1].substring(2) + match[2] + match[3]) : "000000";
    }

    document.getElementById('imageInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        
        const zip = new JSZip();
        // 파일명: 공사명 시료번호 날짜
        const finalName = `${currentData[0].v} ${currentData[1].v} ${getShortDate(currentData[2].v)}`.trim();

        for (let i = 0; i < files.length; i++) {
            statusText.innerText = `${i+1}/${files.length}개 처리 중...`;
            const blob = await processImage(files[i]);
            zip.file(`${finalName}_${i+1}.jpg`, blob);
        }

        const content = await zip.generateAsync({type: "blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = `${finalName || '현장사진'}.zip`;
        link.click();
        statusText.innerText = "완료!";
    });

    async function processImage(file) {
        return new Promise(res => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width; canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    const rowH = canvas.height * 0.055;
                    const fontSize = rowH * 0.55;
                    ctx.font = `${fontSize}px Arial`;
                    
                    let maxVWidth = 0;
                    currentData.forEach(d => {
                        const w = ctx.measureText(d.v).width;
                        if(w > maxVWidth) maxVWidth = w;
                    });
                    const keyWidth = ctx.measureText("공사명일자").width;
                    const padding = 40;
                    const tableW = keyWidth + maxVWidth + (padding * 4);
                    const tableH = rowH * 5;
                    const x = 60, y = canvas.height - tableH - 60;

                    ctx.fillStyle = "white"; ctx.fillRect(x, y, tableW, tableH);
                    ctx.strokeStyle = "black"; ctx.lineWidth = canvas.width * 0.0015;
                    ctx.fillStyle = "black";

                    currentData.forEach((item, i) => {
                        const cy = y + (i * rowH);
                        ctx.strokeRect(x, cy, tableW, rowH);
                        const splitX = x + keyWidth + (padding * 2);
                        ctx.beginPath(); ctx.moveTo(splitX, cy); ctx.lineTo(splitX, cy+rowH); ctx.stroke();
                        ctx.fillText(item.k, x + padding, cy + (rowH * 0.68));
                        ctx.fillText(item.v, splitX + padding, cy + (rowH * 0.68));
                    });
                    canvas.toBlob(res, "image/jpeg", 0.95);
                }
            }
        });
    }

    function saveTemplate() {
        const name = document.getElementById('newTemplateName').value;
        if(!name) return alert("이름 입력");
        let t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        t[name] = JSON.parse(JSON.stringify(currentData));
        localStorage.setItem(storageKey, JSON.stringify(t));
        updateTmplList();
        alert("저장 성공");
    }

    function deleteTemplate() {
        const n = document.getElementById('templateList').value;
        if(!n || !confirm("삭제할까요?")) return;
        let t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        delete t[n];
        localStorage.setItem(storageKey, JSON.stringify(t));
        updateTmplList();
    }

    function updateTmplList() {
        const s = document.getElementById('templateList');
        const t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        s.innerHTML = '<option value="">템플릿 선택</option>';
        for(let n in t) s.innerHTML += `<option value="${n}">${n}</option>`;
    }

    function loadTemplate() {
        const n = document.getElementById('templateList').value;
        const t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        if(t[n]) { currentData = t[n]; currentData[2].v = dateStr; renderFields(); }
    }

    window.onload = () => { renderFields(); updateTmplList(); };
</script>
</body>
</html>