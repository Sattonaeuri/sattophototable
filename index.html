<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í˜„ì¥ ì‚¬ì§„ Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/piexifjs/1.0.6/piexif.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        /* ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ ë³€ìˆ˜ */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #e5e5ea;
            --text-tertiary: #a1a1a6;
            --border-color: #3a3a3c;
            --shadow: rgba(0,0,0,0.5);
        }
        
        body.light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f2f2f7;
            --bg-tertiary: #ffffff;
            --text-primary: #000000;
            --text-secondary: #1c1c1e;
            --text-tertiary: #8e8e93;
            --border-color: #d1d1d6;
            --shadow: rgba(0,0,0,0.1);
        }
        
        body { 
            font-family: -apple-system, sans-serif; 
            padding: 20px; 
            background: var(--bg-primary); 
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            margin: 0;
        }
        
        /* í—¤ë” */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 5px;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            color: var(--text-primary);
            text-align: center;
            flex: 1;
        }
        .settings-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
        }
        .back-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .card { 
            background: var(--bg-secondary); 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            box-shadow: 0 4px 12px var(--shadow); 
            box-sizing: border-box;
            border: 1px solid var(--border-color);
        }
        h3 { 
            margin: 0 0 12px 0; 
            font-size: 16px; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 8px; 
            color: var(--text-secondary); 
        }
        
        /* ë ˆì´ì•„ì›ƒ ìµœì í™” */
        .row { display: flex; gap: 10px; margin-bottom: 8px; align-items: stretch; width: 100%; }
        .col-key { 
            width: 65px; 
            flex: none !important; 
            font-weight: bold; 
            background: var(--bg-tertiary); 
            color: var(--text-tertiary); 
            border: 1px solid var(--border-color); 
            padding: 12px 5px; 
            border-radius: 8px; 
            text-align: center; 
            font-size: 13px; 
            box-sizing: border-box; 
        }
        input, select { 
            flex: 1; 
            min-width: 0; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 15px; 
            background: var(--bg-tertiary); 
            color: var(--text-primary); 
            box-sizing: border-box; 
        }
        
        /* ì…ë ¥ ìƒì ë‚´ë¶€ ì‚­ì œ ë²„íŠ¼ */
        .input-wrapper { position: relative; flex: 1; display: flex; align-items: center; min-width: 0; }
        .input-wrapper input { flex: 1; min-width: 0; }
        .input-with-clear { padding-right: 40px !important; }
        .clear-btn { 
            position: absolute; 
            right: 8px; 
            background: #8e8e93; 
            border: none; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            color: white; 
            font-size: 14px; 
            cursor: pointer; 
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .clear-btn:active { background: #636366; }
        
        /* ë‚ ì§œ ì…ë ¥ */
        input[type="date"] {
            color-scheme: light dark;
            -webkit-appearance: none;
        }
        body.light-mode input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0);
        }
        body:not(.light-mode) input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        button { padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #0a84ff; color: white; width: 100%; margin-top: 10px; }
        .btn-green { background: #30d158; color: white; width: 100%; margin-top: 10px; }
        .btn-red { background: #ff453a; color: white; width: 70px; font-size: 13px; flex-shrink: 0; }
        .btn-gray { background: #8e8e93; color: white; width: 70px; font-size: 13px; flex-shrink: 0; }
        .btn-orange { background: #ff9f0a; color: white; width: 100%; margin-top: 10px; }
        .btn-purple { background: #bf5af2; color: white; width: 100%; margin-top: 10px; }
        
        #status { text-align: center; margin-top: 15px; font-weight: 600; color: #0a84ff; }
        #openFilesBtn, #openDriveBtn, #openDropboxBtn { display: none; }
        
        /* í…Œë§ˆ í† ê¸€ & ê¸°íƒ€ í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .toggle-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #8e8e93;
            transition: .3s;
            border-radius: 31px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #0a84ff;
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        /* í™”ë©´ ì „í™˜ */
        .screen { display: none; }
        .screen.active { display: block; }
        
        .setting-description {
            text-align: center;
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 10px;
        }
        
        /* í´ë¼ìš°ë“œ ì—°ê²° ìƒíƒœ */
        .cloud-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .cloud-status.connected {
            border-color: #30d158;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #8e8e93;
        }
        .status-indicator.connected {
            background: #30d158;
        }
        .cloud-email {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }
    </style>
</head>
<body>

<!-- ë©”ì¸ í™”ë©´ -->
<div id="mainScreen" class="screen active">
    <div class="header">
        <h1>í˜„ì¥ ì‚¬ì§„ Pro</h1>
        <button class="settings-btn" onclick="showSettings()">âš™ï¸</button>
    </div>

    <div class="card">
        <h3>ğŸ“‹ í‘œ ë‚´ìš© ì…ë ¥</h3>
        <div id="tableFields"></div>
    </div>

    <div class="card">
        <h3>ğŸ’¾ í…œí”Œë¦¿ ê´€ë¦¬</h3>
        <div class="row">
            <select id="templateList" onchange="loadTemplate()"><option value="">í…œí”Œë¦¿ ì„ íƒ</option></select>
            <button class="btn-red" onclick="deleteTemplate()">ì‚­ì œ</button>
        </div>
        <div class="row">
            <div class="input-wrapper">
                <input type="text" id="newTemplateName" class="input-with-clear" placeholder="ìƒˆ ì´ë¦„" oninput="toggleClearBtn()">
                <button class="clear-btn" id="clearNameBtn" onclick="clearTemplateName()">âœ•</button>
            </div>
            <button class="btn-gray" onclick="saveTemplate()">ì €ì¥</button>
        </div>
    </div>

    <div class="card">
        <input type="file" id="imageInput" multiple accept="image/jpeg" style="display: none;">
        <button class="btn-blue" onclick="document.getElementById('imageInput').click()">ğŸ“¸ ì‚¬ì§„ ì„ íƒ & ì‘ì—… ì‹œì‘</button>
        <div id="status">ëŒ€ê¸° ì¤‘...</div>
        <button id="openFilesBtn" class="btn-green" onclick="openFilesApp()">ğŸ“‚ íŒŒì¼ ì•± ì—´ê¸°</button>
        <button id="uploadToCloudBtn" class="btn-purple" onclick="manualUploadToCloud()" style="display: none;">â˜ï¸ í´ë¼ìš°ë“œì— ì—…ë¡œë“œ</button>
        <button id="openDropboxBtn" class="btn-purple" onclick="openDropboxFolder()" style="display: none;">ğŸ“‚ Dropboxì—ì„œ ë³´ê¸°</button>
        <button id="openDriveBtn" class="btn-purple" onclick="openDriveFolder()" style="display: none;">ğŸ“‚ Driveì—ì„œ ë³´ê¸°</button>
    </div>

    <div class="card">
        <h3>ğŸ’¾ í…œí”Œë¦¿ ë°±ì—… & ë³µì›</h3>
        <button class="btn-blue" onclick="exportTemplates()">ğŸ“¤ í…œí”Œë¦¿ ë‚´ë³´ë‚´ê¸° (JSON)</button>
        <input type="file" id="importInput" accept="application/json" style="display: none;" onchange="importTemplates(event)">
        <button class="btn-green" onclick="document.getElementById('importInput').click()">ğŸ“¥ í…œí”Œë¦¿ ê°€ì ¸ì˜¤ê¸° (JSON)</button>
    </div>
</div>

<!-- ì„¤ì • í™”ë©´ -->
<div id="settingsScreen" class="screen">
    <div class="header">
        <button class="back-btn" onclick="showMain()">â† ë’¤ë¡œê°€ê¸°</button>
        <h1>ì„¤ì •</h1>
        <div style="width: 40px;"></div>
    </div>

    <div class="card">
        <h3>ğŸ“¦ Dropbox ì—°ë™ (ê¶Œì¥)</h3>
        <div class="cloud-status" id="dropboxStatus">
            <div class="status-indicator" id="dropboxIndicator"></div>
            <span class="cloud-email" id="dropboxEmail">ì—°ê²°ë˜ì§€ ì•ŠìŒ</span>
        </div>
        <button class="btn-blue" id="dropboxConnectBtn" onclick="connectDropbox()">Dropbox ê³„ì • ì—°ê²°</button>
        <button class="btn-red" id="dropboxDisconnectBtn" onclick="disconnectDropbox()" style="display: none; width: 100%;">ì—°ê²° í•´ì œ</button>
        
        <div class="toggle-row" style="margin-top: 15px;">
            <span class="toggle-label">Dropbox ìë™ ì—…ë¡œë“œ</span>
            <label class="switch">
                <input type="checkbox" id="dropboxAutoUpload" onchange="toggleDropboxSettings()">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="toggle-row" style="margin-top: 15px;">
            <span class="toggle-label">í™•ì¸ í›„ ì—…ë¡œë“œ</span>
            <label class="switch">
                <input type="checkbox" id="dropboxManualUpload" onchange="toggleDropboxSettings()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-description">âœ¨ í•œ ë²ˆ ì—°ê²°í•˜ë©´ ì¬ì—°ê²° ì—†ì´ ì˜êµ¬ ì‚¬ìš© ê°€ëŠ¥!</div>
    </div>

    <div class="card">
        <h3>â˜ï¸ Google Drive ì—°ë™</h3>
        <div class="cloud-status" id="driveStatus">
            <div class="status-indicator" id="driveIndicator"></div>
            <span class="cloud-email" id="driveEmail">ì—°ê²°ë˜ì§€ ì•ŠìŒ</span>
        </div>
        <button class="btn-blue" id="driveConnectBtn" onclick="connectGoogleDrive()">Google ê³„ì • ì—°ê²°</button>
        <button class="btn-red" id="driveDisconnectBtn" onclick="disconnectGoogleDrive()" style="display: none; width: 100%;">ì—°ê²° í•´ì œ</button>
        
        <div class="toggle-row" style="margin-top: 15px;">
            <span class="toggle-label">Drive ìë™ ì—…ë¡œë“œ</span>
            <label class="switch">
                <input type="checkbox" id="driveAutoUpload" onchange="toggleDriveSettings()">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="toggle-row" style="margin-top: 15px;">
            <span class="toggle-label">í™•ì¸ í›„ ì—…ë¡œë“œ</span>
            <label class="switch">
                <input type="checkbox" id="driveManualUpload" onchange="toggleDriveSettings()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-description">âš ï¸ 1ì‹œê°„ë§ˆë‹¤ ì¬ì—°ê²° í•„ìš”</div>
    </div>

    <div class="card">
        <h3>ğŸ¨ í…Œë§ˆ ì„¤ì •</h3>
        <div class="toggle-row">
            <span class="toggle-label">ë‹¤í¬ ëª¨ë“œ</span>
            <label class="switch">
                <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-description">ë°ì€ í™”ë©´ì„ ì›í•˜ì‹œë©´ í† ê¸€ì„ ë„ì„¸ìš”</div>
    </div>

    <div class="card">
        <h3>ğŸ”„ ì•± ì—…ë°ì´íŠ¸</h3>
        <button class="btn-orange" onclick="updateApp()">ğŸ”„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸</button>
        <div class="setting-description">ìºì‹œë¥¼ ì‚­ì œí•˜ê³  ìµœì‹  ë²„ì „ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</div>
    </div>
</div>

<script>
    // ========== ì„¤ì • í‚¤ ==========
    const storageKey = 'photo_pro_v8_final';
    const themeKey = 'photo_pro_theme';
    const driveKey = 'photo_pro_drive';
    const dropboxKey = 'photo_pro_dropbox';
    
    // ========== Google Drive API ì„¤ì • ==========
    const GOOGLE_CLIENT_ID = '1020242242798-ai14uvgmjsvmvbqp4fpb2unb6hjnqrr8.apps.googleusercontent.com';
    const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
    
    // ========== Dropbox API ì„¤ì • ==========
    const DROPBOX_CLIENT_ID = 'eafpljx4claj83h';
    const DROPBOX_REDIRECT_URI = window.location.origin + window.location.pathname;
    
    // ========== ì „ì—­ ë³€ìˆ˜ ==========
    let gapiInited = false;
    let googleTokenClient;
    let googleAccessToken = null;
    let googleLastFolderId = null;
    
    let dropboxAccessToken = null;
    let dropboxRefreshToken = null;
    let dropboxLastPath = null;
    
    let currentZipBlob = null;
    let currentZipFileName = null;
    
    const statusText = document.getElementById('status');
    const openFilesBtn = document.getElementById('openFilesBtn');
    const today = new Date();
    const dateStr = `${today.getFullYear()}ë…„ ${String(today.getMonth() + 1).padStart(2, '0')}ì›” ${String(today.getDate()).padStart(2, '0')}ì¼`;
    
    let currentTemplateName = "";
    let currentData = [
        {k: "ê³µì‚¬ëª…", v: ""}, {k: "ì‹œë£Œë²ˆí˜¸", v: ""},
        {k: "ì¼ì", v: dateStr}, {k: "ì±„ì·¨êµ¬ë¶„", v: ""}, {k: "ì¡°ì‚¬ì", v: ""}
    ];

    // ========== Google API ì´ˆê¸°í™” ==========
    function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
        await gapi.client.init({
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
        });
        gapiInited = true;
        checkDriveConnection();
    }

    function gisLoaded() {
        googleTokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: GOOGLE_SCOPES,
            prompt: '',
            callback: async (response) => {
                if (response.error !== undefined) {
                    throw (response);
                }
                googleAccessToken = response.access_token;
                await saveGoogleToken(response);
                await updateDriveStatus();
                alert('Google Driveì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!');
            },
        });
    }

    // ========== Dropbox OAuth (PKCE ë°©ì‹ - iOS í˜¸í™˜) ==========
    
    // PKCEìš© ëœë¤ ë¬¸ìì—´ ìƒì„± (iOS Safari í˜¸í™˜)
    function generateRandomString(length) {
        const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
        let text = '';
        
        // crypto.getRandomValues ì•ˆì „í•˜ê²Œ ì‚¬ìš©
        if (window.crypto && window.crypto.getRandomValues) {
            const array = new Uint8Array(length);
            window.crypto.getRandomValues(array);
            for (let i = 0; i < length; i++) {
                text += possible.charAt(array[i] % possible.length);
            }
        } else {
            // fallback for older browsers
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
        }
        return text;
    }
    
    // SHA-256 í•´ì‹œ ìƒì„± (iOS Safari í˜¸í™˜)
    async function sha256(plain) {
        const encoder = new TextEncoder();
        const data = encoder.encode(plain);
        
        // SubtleCrypto ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        if (window.crypto && window.crypto.subtle && window.crypto.subtle.digest) {
            return await window.crypto.subtle.digest('SHA-256', data);
        } else {
            // Fallback: SHA-256 ì—†ì´ code_verifierë¥¼ ê·¸ëŒ€ë¡œ challengeë¡œ ì‚¬ìš© (plain method)
            // ë³´ì•ˆì€ ì•½ê°„ ë–¨ì–´ì§€ì§€ë§Œ ì‘ë™ì€ ë¨
            throw new Error('SHA-256 not supported');
        }
    }
    
    // Base64 URL ì¸ì½”ë”©
    function base64urlencode(arrayBuffer) {
        const bytes = new Uint8Array(arrayBuffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary)
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=+$/, "");
    }
    
    async function connectDropbox() {
        try {
            // PKCE code verifier ìƒì„±
            const codeVerifier = generateRandomString(128);
            sessionStorage.setItem('dropbox_code_verifier', codeVerifier);
            
            let authUrl;
            
            // Code challenge ìƒì„± ì‹œë„
            try {
                const hashed = await sha256(codeVerifier);
                const codeChallenge = base64urlencode(hashed);
                
                // S256 ë°©ì‹ìœ¼ë¡œ ì¸ì¦ URL ìƒì„±
                authUrl = `https://www.dropbox.com/oauth2/authorize?` +
                    `client_id=${DROPBOX_CLIENT_ID}&` +
                    `response_type=code&` +
                    `redirect_uri=${encodeURIComponent(DROPBOX_REDIRECT_URI)}&` +
                    `code_challenge=${codeChallenge}&` +
                    `code_challenge_method=S256&` +
                    `token_access_type=offline`;
            } catch (e) {
                // SHA-256 ì‹¤íŒ¨ì‹œ plain ë°©ì‹ ì‚¬ìš©
                console.log('Using plain PKCE method');
                authUrl = `https://www.dropbox.com/oauth2/authorize?` +
                    `client_id=${DROPBOX_CLIENT_ID}&` +
                    `response_type=code&` +
                    `redirect_uri=${encodeURIComponent(DROPBOX_REDIRECT_URI)}&` +
                    `code_challenge=${codeVerifier}&` +
                    `code_challenge_method=plain&` +
                    `token_access_type=offline`;
            }
            
            sessionStorage.setItem('dropbox_auth_pending', 'true');
            window.location.href = authUrl;
        } catch (error) {
            console.error('Dropbox ì—°ê²° ì‹œì‘ ì‹¤íŒ¨:', error);
            alert('Dropbox ì—°ê²°ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    async function handleDropboxCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        
        if (code && sessionStorage.getItem('dropbox_auth_pending')) {
            sessionStorage.removeItem('dropbox_auth_pending');
            
            const codeVerifier = sessionStorage.getItem('dropbox_code_verifier');
            sessionStorage.removeItem('dropbox_code_verifier');
            
            if (!codeVerifier) {
                alert('ì¸ì¦ ê³¼ì •ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            try {
                // í† í° êµí™˜
                const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        code: code,
                        grant_type: 'authorization_code',
                        client_id: DROPBOX_CLIENT_ID,
                        redirect_uri: DROPBOX_REDIRECT_URI,
                        code_verifier: codeVerifier
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Token exchange failed: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.access_token) {
                    dropboxAccessToken = data.access_token;
                    dropboxRefreshToken = data.refresh_token;
                    
                    // ê³„ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const accountInfo = await fetch('https://api.dropboxapi.com/2/users/get_current_account', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${dropboxAccessToken}`
                        }
                    });
                    
                    if (!accountInfo.ok) {
                        throw new Error('Failed to get account info');
                    }
                    
                    const accountData = await accountInfo.json();
                    
                    // ì €ì¥
                    const dropboxData = {
                        access_token: dropboxAccessToken,
                        refresh_token: dropboxRefreshToken,
                        expires_at: Date.now() + (14400 * 1000), // 4ì‹œê°„
                        email: accountData.email,
                        autoUpload: false,
                        manualUpload: false
                    };
                    
                    localStorage.setItem(dropboxKey, JSON.stringify(dropboxData));
                    
                    // URL ì •ë¦¬
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    await updateDropboxStatus();
                    alert('Dropboxì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    throw new Error(data.error_description || 'No access token received');
                }
            } catch (error) {
                console.error('Dropbox ì¸ì¦ ì‹¤íŒ¨:', error);
                alert('Dropbox ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n' + error.message);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
    }

    async function disconnectDropbox() {
        if (confirm('Dropbox ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            localStorage.removeItem(dropboxKey);
            dropboxAccessToken = null;
            dropboxRefreshToken = null;
            await updateDropboxStatus();
            alert('ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function loadDropboxToken() {
        const saved = localStorage.getItem(dropboxKey);
        if (!saved) return false;
        
        const dropboxData = JSON.parse(saved);
        
        // í† í° ë§Œë£Œ í™•ì¸ (30ë¶„ ì—¬ìœ )
        if (Date.now() >= (dropboxData.expires_at - 1800000)) {
            // Refresh tokenìœ¼ë¡œ ê°±ì‹ 
            if (dropboxData.refresh_token) {
                try {
                    const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            grant_type: 'refresh_token',
                            refresh_token: dropboxData.refresh_token,
                            client_id: DROPBOX_CLIENT_ID
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.access_token) {
                        dropboxAccessToken = data.access_token;
                        
                        // ìƒˆ í† í° ì €ì¥
                        dropboxData.access_token = data.access_token;
                        dropboxData.expires_at = Date.now() + (14400 * 1000);
                        localStorage.setItem(dropboxKey, JSON.stringify(dropboxData));
                    }
                } catch (error) {
                    console.error('í† í° ê°±ì‹  ì‹¤íŒ¨:', error);
                    return false;
                }
            } else {
                return false;
            }
        } else {
            dropboxAccessToken = dropboxData.access_token;
            dropboxRefreshToken = dropboxData.refresh_token;
        }
        
        // ì„¤ì • ë³µì›
        document.getElementById('dropboxAutoUpload').checked = dropboxData.autoUpload || false;
        document.getElementById('dropboxManualUpload').checked = dropboxData.manualUpload || false;
        
        return true;
    }

    async function updateDropboxStatus() {
        const status = document.getElementById('dropboxStatus');
        const indicator = document.getElementById('dropboxIndicator');
        const email = document.getElementById('dropboxEmail');
        const connectBtn = document.getElementById('dropboxConnectBtn');
        const disconnectBtn = document.getElementById('dropboxDisconnectBtn');
        
        const saved = localStorage.getItem(dropboxKey);
        
        if (dropboxAccessToken && saved) {
            const dropboxData = JSON.parse(saved);
            status.classList.add('connected');
            indicator.classList.add('connected');
            email.textContent = dropboxData.email || 'ì—°ê²°ë¨';
            connectBtn.style.display = 'none';
            disconnectBtn.style.display = 'block';
        } else {
            status.classList.remove('connected');
            indicator.classList.remove('connected');
            email.textContent = 'ì—°ê²°ë˜ì§€ ì•ŠìŒ';
            connectBtn.style.display = 'block';
            disconnectBtn.style.display = 'none';
        }
    }

    function toggleDropboxSettings() {
        const saved = localStorage.getItem(dropboxKey);
        if (saved) {
            const dropboxData = JSON.parse(saved);
            dropboxData.autoUpload = document.getElementById('dropboxAutoUpload').checked;
            dropboxData.manualUpload = document.getElementById('dropboxManualUpload').checked;
            localStorage.setItem(dropboxKey, JSON.stringify(dropboxData));
        }
    }

    async function uploadToDropbox(blob, fileName) {
        if (!dropboxAccessToken) {
            throw new Error('Dropboxì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${dropboxAccessToken}`,
                'Content-Type': 'application/octet-stream',
                'Dropbox-API-Arg': JSON.stringify({
                    path: '/' + fileName,
                    mode: 'add',
                    autorename: true,
                    mute: false
                })
            },
            body: blob
        });

        if (!response.ok) {
            throw new Error('Dropbox ì—…ë¡œë“œ ì‹¤íŒ¨');
        }

        const result = await response.json();
        dropboxLastPath = result.path_display;
        return result;
    }

    function openDropboxFolder() {
        window.open('https://www.dropbox.com/home', '_blank');
    }

    // ========== Google Drive ê´€ë¦¬ ==========
    async function connectGoogleDrive() {
        if (!gapiInited || !googleTokenClient) {
            alert('Google APIê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
        }
        googleTokenClient.requestAccessToken({ prompt: 'consent' });
    }

    async function disconnectGoogleDrive() {
        if (confirm('Google Drive ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            if (googleAccessToken) {
                google.accounts.oauth2.revoke(googleAccessToken);
            }
            localStorage.removeItem(driveKey);
            googleAccessToken = null;
            await updateDriveStatus();
            alert('ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function saveGoogleToken(response) {
        const driveData = {
            access_token: response.access_token,
            expires_at: Date.now() + (response.expires_in * 1000),
            autoUpload: document.getElementById('driveAutoUpload').checked,
            manualUpload: document.getElementById('driveManualUpload').checked
        };
        
        try {
            const userInfo = await gapi.client.request({
                path: 'https://www.googleapis.com/oauth2/v2/userinfo'
            });
            driveData.email = userInfo.result.email;
        } catch (err) {
            console.error('ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
        }
        
        localStorage.setItem(driveKey, JSON.stringify(driveData));
    }

    async function loadGoogleToken() {
        const saved = localStorage.getItem(driveKey);
        if (!saved) return false;
        
        const driveData = JSON.parse(saved);
        
        if (Date.now() >= (driveData.expires_at - 300000)) {
            return false;
        }
        
        googleAccessToken = driveData.access_token;
        gapi.client.setToken({ access_token: googleAccessToken });
        
        document.getElementById('driveAutoUpload').checked = driveData.autoUpload || false;
        document.getElementById('driveManualUpload').checked = driveData.manualUpload || false;
        
        return true;
    }

    async function checkDriveConnection() {
        const connected = await loadGoogleToken();
        await updateDriveStatus();
    }

    async function updateDriveStatus() {
        const status = document.getElementById('driveStatus');
        const indicator = document.getElementById('driveIndicator');
        const email = document.getElementById('driveEmail');
        const connectBtn = document.getElementById('driveConnectBtn');
        const disconnectBtn = document.getElementById('driveDisconnectBtn');
        
        const saved = localStorage.getItem(driveKey);
        
        if (googleAccessToken && saved) {
            const driveData = JSON.parse(saved);
            status.classList.add('connected');
            indicator.classList.add('connected');
            email.textContent = driveData.email || 'ì—°ê²°ë¨';
            connectBtn.style.display = 'none';
            disconnectBtn.style.display = 'block';
        } else {
            status.classList.remove('connected');
            indicator.classList.remove('connected');
            email.textContent = 'ì—°ê²°ë˜ì§€ ì•ŠìŒ';
            connectBtn.style.display = 'block';
            disconnectBtn.style.display = 'none';
        }
    }

    function toggleDriveSettings() {
        const saved = localStorage.getItem(driveKey);
        if (saved) {
            const driveData = JSON.parse(saved);
            driveData.autoUpload = document.getElementById('driveAutoUpload').checked;
            driveData.manualUpload = document.getElementById('driveManualUpload').checked;
            localStorage.setItem(driveKey, JSON.stringify(driveData));
        }
    }

    async function ensureValidGoogleToken() {
        const saved = localStorage.getItem(driveKey);
        if (!saved) return false;
        
        const driveData = JSON.parse(saved);
        
        if (Date.now() >= (driveData.expires_at - 300000)) {
            alert('Google Drive ì—°ê²°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì„¤ì •ì—ì„œ ë‹¤ì‹œ ì—°ê²°í•´ì£¼ì„¸ìš”.');
            googleAccessToken = null;
            return false;
        }
        
        return true;
    }

    async function uploadToGoogleDrive(blob, fileName) {
        if (!await ensureValidGoogleToken()) {
            throw new Error('Google Drive ì—°ê²°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        if (!googleAccessToken) {
            throw new Error('Google Driveì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        const metadata = {
            name: fileName,
            mimeType: 'application/zip'
        };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', blob);

        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${googleAccessToken}`
            },
            body: form
        });

        if (!response.ok) {
            throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');
        }

        const result = await response.json();
        googleLastFolderId = result.id;
        return result;
    }

    function openDriveFolder() {
        if (googleLastFolderId) {
            window.open(`https://drive.google.com/file/d/${googleLastFolderId}/view`, '_blank');
        } else {
            window.open('https://drive.google.com/drive/my-drive', '_blank');
        }
    }

    // ========== í´ë¼ìš°ë“œ ì—…ë¡œë“œ í†µí•© ==========
    async function manualUploadToCloud() {
        if (!currentZipBlob || !currentZipFileName) {
            alert('ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // Dropbox ìš°ì„ 
        const dropboxData = localStorage.getItem(dropboxKey);
        const driveData = localStorage.getItem(driveKey);
        
        const useDropbox = dropboxData && JSON.parse(dropboxData).autoUpload && dropboxAccessToken;
        const useDrive = driveData && JSON.parse(driveData).autoUpload && googleAccessToken;
        
        if (!useDropbox && !useDrive) {
            alert('í´ë¼ìš°ë“œì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\nì„¤ì •ì—ì„œ ì—°ê²°í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        try {
            statusText.innerText = 'í´ë¼ìš°ë“œì— ì—…ë¡œë“œ ì¤‘...';
            document.getElementById('uploadToCloudBtn').disabled = true;
            
            if (useDropbox) {
                await uploadToDropbox(currentZipBlob, currentZipFileName);
                statusText.innerText = 'Dropbox ì—…ë¡œë“œ ì™„ë£Œ!';
                document.getElementById('openDropboxBtn').style.display = 'block';
            } else if (useDrive) {
                await uploadToGoogleDrive(currentZipBlob, currentZipFileName);
                statusText.innerText = 'Drive ì—…ë¡œë“œ ì™„ë£Œ!';
                document.getElementById('openDriveBtn').style.display = 'block';
            }
            
            document.getElementById('uploadToCloudBtn').style.display = 'none';
        } catch (error) {
            console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            statusText.innerText = 'ì—…ë¡œë“œ ì‹¤íŒ¨';
            alert('ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ ë‹¤ì‹œ ì—°ê²°í•´ì£¼ì„¸ìš”.');
            document.getElementById('uploadToCloudBtn').disabled = false;
        }
    }

    // ========== í™”ë©´ ì „í™˜ ==========
    function showSettings() {
        document.getElementById('mainScreen').classList.remove('active');
        document.getElementById('settingsScreen').classList.add('active');
    }

    function showMain() {
        document.getElementById('settingsScreen').classList.remove('active');
        document.getElementById('mainScreen').classList.add('active');
    }

    // ========== í…Œë§ˆ ==========
    function toggleTheme() {
        const isDark = document.getElementById('themeToggle').checked;
        if (isDark) {
            document.body.classList.remove('light-mode');
            localStorage.setItem(themeKey, 'dark');
        } else {
            document.body.classList.add('light-mode');
            localStorage.setItem(themeKey, 'light');
        }
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem(themeKey) || 'dark';
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            document.getElementById('themeToggle').checked = false;
        } else {
            document.body.classList.remove('light-mode');
            document.getElementById('themeToggle').checked = true;
        }
    }

    // ========== ê¸°ë³¸ í•¨ìˆ˜ ==========
    function formatDateToKorean(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}ë…„ ${month}ì›” ${day}ì¼`;
    }

    function koreanToISO(koreanDate) {
        const match = koreanDate.match(/(\d{4})ë…„ (\d{2})ì›” (\d{2})ì¼/);
        return match ? `${match[1]}-${match[2]}-${match[3]}` : '';
    }

    function renderFields() {
        const container = document.getElementById('tableFields');
        container.innerHTML = '';
        currentData.forEach((item, i) => {
            const row = document.createElement('div');
            row.className = 'row';
            
            if (item.k === "ì¼ì") {
                const isoDate = koreanToISO(item.v);
                row.innerHTML = `<input type="text" class="col-key" value="${item.k}" oninput="currentData[${i}].k=this.value">
                                 <input type="date" value="${isoDate}" onchange="updateDateField(${i}, this.value)">`;
            } else {
                row.innerHTML = `<input type="text" class="col-key" value="${item.k}" oninput="currentData[${i}].k=this.value">
                                 <div class="input-wrapper">
                                     <input type="text" class="input-with-clear" value="${item.v}" oninput="currentData[${i}].v=this.value; toggleFieldClearBtn(${i}, 'value')">
                                     <button class="clear-btn" id="clearValue${i}" onclick="clearFieldInput(${i}, 'value')">âœ•</button>
                                 </div>`;
            }
            container.appendChild(row);
            
            if (item.k !== "ì¼ì") {
                setTimeout(() => {
                    toggleFieldClearBtn(i, 'value');
                }, 0);
            }
        });
    }

    function updateDateField(index, isoDate) {
        if (isoDate) {
            const [year, month, day] = isoDate.split('-');
            currentData[index].v = `${year}ë…„ ${month}ì›” ${day}ì¼`;
        }
    }

    function getShortDate(str) {
        const match = str.match(/(\d{4})ë…„ (\d{2})ì›” (\d{2})ì¼/);
        return match ? (match[1].substring(2) + match[2] + match[3]) : "000000";
    }

    async function getExifDateTime(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                try {
                    const exifObj = piexif.load(e.target.result);
                    const dateTime = exifObj['0th'][piexif.ImageIFD.DateTime] || 
                                   exifObj['Exif'][piexif.ExifIFD.DateTimeOriginal] || 
                                   '';
                    if (dateTime) {
                        const [date, time] = dateTime.split(' ');
                        const [year, month, day] = date.split(':');
                        const [hour, min, sec] = time.split(':');
                        resolve(new Date(year, month - 1, day, hour, min, sec));
                    } else {
                        resolve(new Date(0));
                    }
                } catch (err) {
                    resolve(new Date(0));
                }
            };
        });
    }

    document.getElementById('imageInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        
        openFilesBtn.style.display = 'none';
        document.getElementById('openDropboxBtn').style.display = 'none';
        document.getElementById('openDriveBtn').style.display = 'none';
        statusText.innerText = 'ì´¬ì˜ ì‹œê°„ ë¶„ì„ ì¤‘...';
        
        const filesWithTime = await Promise.all(
            files.map(async (file) => ({
                file: file,
                time: await getExifDateTime(file)
            }))
        );
        
        filesWithTime.sort((a, b) => a.time - b.time);
        const sortedFiles = filesWithTime.map(item => item.file);
        
        const zip = new JSZip();
        
        const baseTitle = currentTemplateName || currentData[0].v || "í˜„ì¥ì‚¬ì§„";
        const sampleNumber = currentData[1].v;
        const datePart = getShortDate(currentData[2].v);
        
        const zipFileName = sampleNumber 
            ? `${baseTitle} ${sampleNumber} ${datePart}`.trim()
            : `${baseTitle} ${datePart}`.trim();

        const photoBaseName = sampleNumber || "ì‚¬ì§„";
        
        for (let i = 0; i < sortedFiles.length; i++) {
            statusText.innerText = `${i+1}/${sortedFiles.length}ê°œ ì²˜ë¦¬ ì¤‘...`;
            const blob = await processImage(sortedFiles[i]);
            zip.file(`${photoBaseName} (${i+1}).jpg`, blob);
        }

        const content = await zip.generateAsync({type: "blob"});
        
        currentZipBlob = content;
        currentZipFileName = `${zipFileName}.zip`;
        
        // 1. ë¡œì»¬ ë‹¤ìš´ë¡œë“œ (í•­ìƒ)
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = currentZipFileName;
        link.click();
        statusText.innerText = "ë¡œì»¬ ì €ì¥ ì™„ë£Œ!";
        openFilesBtn.style.display = 'block';
        
        // 2. í´ë¼ìš°ë“œ ì—…ë¡œë“œ (ì„¤ì •ì— ë”°ë¼)
        const dropboxData = localStorage.getItem(dropboxKey);
        const driveData = localStorage.getItem(driveKey);
        
        const useDropbox = dropboxData && JSON.parse(dropboxData).autoUpload && dropboxAccessToken;
        const useDrive = !useDropbox && driveData && JSON.parse(driveData).autoUpload && googleAccessToken;
        
        if (useDropbox || useDrive) {
            const isManual = useDropbox 
                ? JSON.parse(dropboxData).manualUpload 
                : JSON.parse(driveData).manualUpload;
            
            if (isManual) {
                statusText.innerText = "ë¡œì»¬ ì €ì¥ ì™„ë£Œ! í™•ì¸ í›„ í´ë¼ìš°ë“œì— ì—…ë¡œë“œí•˜ì„¸ìš”.";
                document.getElementById('uploadToCloudBtn').style.display = 'block';
                document.getElementById('uploadToCloudBtn').disabled = false;
            } else {
                try {
                    statusText.innerText = 'í´ë¼ìš°ë“œì— ì—…ë¡œë“œ ì¤‘...';
                    
                    if (useDropbox) {
                        await uploadToDropbox(content, currentZipFileName);
                        statusText.innerText = 'ë¡œì»¬ ì €ì¥ & Dropbox ì—…ë¡œë“œ ì™„ë£Œ!';
                        document.getElementById('openDropboxBtn').style.display = 'block';
                    } else if (useDrive) {
                        await uploadToGoogleDrive(content, currentZipFileName);
                        statusText.innerText = 'ë¡œì»¬ ì €ì¥ & Drive ì—…ë¡œë“œ ì™„ë£Œ!';
                        document.getElementById('openDriveBtn').style.display = 'block';
                    }
                } catch (error) {
                    console.error('í´ë¼ìš°ë“œ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                    statusText.innerText = 'ë¡œì»¬ ì €ì¥ ì™„ë£Œ! (í´ë¼ìš°ë“œ ì—…ë¡œë“œ ì‹¤íŒ¨)';
                }
            }
        }
    });

    async function processImage(file) {
        return new Promise(res => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const originalDataUrl = e.target.result;
                const img = new Image();
                img.src = originalDataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width; canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    const rowH = canvas.height * 0.045;
                    const fontSize = rowH * 0.75;
                    ctx.font = `${fontSize}px Arial`;
                    ctx.textBaseline = 'middle';
                    
                    let maxVWidth = 0;
                    currentData.forEach(d => {
                        const w = ctx.measureText(d.v).width;
                        if(w > maxVWidth) maxVWidth = w;
                    });
                    const keyWidth = ctx.measureText("ê³µì‚¬ëª…ì¼ì").width;
                    const padding = 40;
                    const tableW = keyWidth + maxVWidth + (padding * 4);
                    const tableH = rowH * 5;
                    const x = 60, y = canvas.height - tableH - 60;

                    ctx.fillStyle = "white"; ctx.fillRect(x, y, tableW, tableH);
                    ctx.strokeStyle = "black"; ctx.lineWidth = canvas.width * 0.0015;
                    ctx.fillStyle = "black";

                    currentData.forEach((item, i) => {
                        const cy = y + (i * rowH);
                        ctx.strokeRect(x, cy, tableW, rowH);
                        const splitX = x + keyWidth + (padding * 2);
                        ctx.beginPath(); ctx.moveTo(splitX, cy); ctx.lineTo(splitX, cy+rowH); ctx.stroke();
                        ctx.fillText(item.k, x + padding, cy + (rowH * 0.5));
                        ctx.fillText(item.v, splitX + padding, cy + (rowH * 0.5));
                    });

                    canvas.toBlob(blob => {
                        const reader2 = new FileReader();
                        reader2.readAsDataURL(blob);
                        reader2.onload = (e2) => {
                            const newDataUrl = e2.target.result;
                            try {
                                const exifObj = piexif.load(originalDataUrl);
                                const exifStr = piexif.dump(exifObj);
                                const finalDataUrl = piexif.insert(exifStr, newDataUrl);
                                fetch(finalDataUrl).then(r => r.blob()).then(res);
                            } catch (err) {
                                res(blob);
                            }
                        };
                    }, "image/jpeg", 0.95);
                }
            }
        });
    }

    function openFilesApp() {
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        
        if (isIOS) {
            window.location.href = 'shareddocuments://';
        } else if (isAndroid) {
            alert('íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œ í´ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            alert('íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }

    function saveTemplate() {
        const name = document.getElementById('newTemplateName').value;
        if(!name) return alert("ì´ë¦„ ì…ë ¥");
        let t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        t[name] = JSON.parse(JSON.stringify(currentData));
        localStorage.setItem(storageKey, JSON.stringify(t));
        currentTemplateName = name;
        updateTmplList();
        document.getElementById('templateList').value = name;
        alert("ì €ì¥ ì„±ê³µ");
    }

    function loadTemplate() {
        const n = document.getElementById('templateList').value;
        const nameInput = document.getElementById('newTemplateName');
        
        if(!n) { 
            currentTemplateName = ""; 
            nameInput.value = "";
            toggleClearBtn();
            return; 
        }
        
        const t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        if(t[n]) { 
            currentData = t[n]; 
            currentData[2].v = dateStr;
            currentTemplateName = n;
            nameInput.value = n;
            toggleClearBtn();
            renderFields(); 
        }
    }

    function deleteTemplate() {
        const n = document.getElementById('templateList').value;
        if(!n || !confirm("ì‚­ì œí• ê¹Œìš”?")) return;
        let t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        delete t[n];
        localStorage.setItem(storageKey, JSON.stringify(t));
        if(currentTemplateName === n) {
            currentTemplateName = "";
            document.getElementById('newTemplateName').value = "";
        }
        updateTmplList();
    }

    function updateTmplList() {
        const s = document.getElementById('templateList');
        const t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        s.innerHTML = '<option value="">í…œí”Œë¦¿ ì„ íƒ</option>';
        for(let n in t) s.innerHTML += `<option value="${n}">${n}</option>`;
    }

    function clearTemplateName() {
        document.getElementById('newTemplateName').value = '';
        document.getElementById('clearNameBtn').style.display = 'none';
    }

    function toggleClearBtn() {
        const input = document.getElementById('newTemplateName');
        const btn = document.getElementById('clearNameBtn');
        btn.style.display = input.value ? 'flex' : 'none';
    }

    function clearFieldInput(index, type) {
        currentData[index].v = '';
        renderFields();
    }

    function toggleFieldClearBtn(index, type) {
        const btnId = `clearValue${index}`;
        const btn = document.getElementById(btnId);
        if (!btn) return;
        
        const value = currentData[index].v;
        btn.style.display = value ? 'flex' : 'none';
    }

    function exportTemplates() {
        const templates = localStorage.getItem(storageKey);
        if (!templates || templates === '{}') {
            alert('ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(templates);
        const downloadAnchor = document.createElement('a');
        downloadAnchor.setAttribute("href", dataStr);
        downloadAnchor.setAttribute("download", "photo_pro_templates.json");
        downloadAnchor.click();
        alert('í…œí”Œë¦¿ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤!');
    }

    function importTemplates(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                
                const existing = JSON.parse(localStorage.getItem(storageKey) || '{}');
                const existingCount = Object.keys(existing).length;
                
                let shouldMerge = true;
                if (existingCount > 0) {
                    shouldMerge = confirm(`ê¸°ì¡´ í…œí”Œë¦¿ ${existingCount}ê°œê°€ ìˆìŠµë‹ˆë‹¤.\n\ní™•ì¸: ê¸°ì¡´ í…œí”Œë¦¿ê³¼ ë³‘í•©\nì·¨ì†Œ: ê¸°ì¡´ í…œí”Œë¦¿ ì‚­ì œ í›„ ê°€ì ¸ì˜¤ê¸°`);
                }
                
                if (shouldMerge) {
                    const merged = {...existing, ...importedData};
                    localStorage.setItem(storageKey, JSON.stringify(merged));
                } else {
                    localStorage.setItem(storageKey, JSON.stringify(importedData));
                }
                
                updateTmplList();
                alert('í…œí”Œë¦¿ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!');
                document.getElementById('importInput').value = '';
            } catch (error) {
                alert('ì˜¬ë°”ë¥¸ í…œí”Œë¦¿ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
            }
        };
        reader.readAsText(file);
    }

    function updateApp() {
        if (confirm('ì•±ì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            window.location.reload(true);
        }
    }

    // ========== ì´ˆê¸°í™” ==========
    window.onload = async () => { 
        renderFields(); 
        updateTmplList(); 
        loadTheme();
        
        // í”Œë«í¼ë³„ ë²„íŠ¼ í…ìŠ¤íŠ¸
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        
        if (isAndroid) {
            document.getElementById('openFilesBtn').textContent = 'ğŸ“‚ ë‹¤ìš´ë¡œë“œ í´ë” í™•ì¸';
        } else if (isIOS) {
            document.getElementById('openFilesBtn').textContent = 'ğŸ“‚ íŒŒì¼ ì•± ì—´ê¸°';
        }
        
        // Google API ì´ˆê¸°í™”
        if (typeof gapi !== 'undefined') {
            gapiLoaded();
        }
        if (typeof google !== 'undefined') {
            gisLoaded();
        }
        
        // Dropbox í† í° ë¡œë“œ
        await loadDropboxToken();
        await updateDropboxStatus();
        
        // Dropbox OAuth ì½œë°± ì²˜ë¦¬
        await handleDropboxCallback();
    };
</script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
