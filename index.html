<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í˜„ì¥ ì‚¬ì§„ Pro (HEIC íŒ¨ì¹˜)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/piexifjs/1.0.6/piexif.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #e5e5ea;
            --text-tertiary: #a1a1a6;
            --border-color: #3a3a3c;
            --shadow: rgba(0,0,0,0.5);
        }
        
        body.light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f2f2f7;
            --bg-tertiary: #ffffff;
            --text-primary: #000000;
            --text-secondary: #1c1c1e;
            --text-tertiary: #8e8e93;
            --border-color: #d1d1d6;
            --shadow: rgba(0,0,0,0.1);
        }
        
        body { 
            font-family: -apple-system, sans-serif; 
            padding: 20px; 
            background: var(--bg-primary); 
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            margin: 0;
        }
        
        /* í—¤ë” */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 5px;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            color: var(--text-primary);
        }
        .settings-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
        }
        .back-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .card { 
            background: var(--bg-secondary); 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            box-shadow: 0 4px 12px var(--shadow); 
            box-sizing: border-box;
            border: 1px solid var(--border-color);
        }
        h3 { 
            margin: 0 0 12px 0; 
            font-size: 16px; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 8px; 
            color: var(--text-secondary); 
        }
        
        /* ë ˆì´ì•„ì›ƒ ìµœì í™” */
        .row { display: flex; gap: 10px; margin-bottom: 8px; align-items: stretch; width: 100%; }
        .col-key { 
            width: 65px; 
            flex: none !important; 
            font-weight: bold; 
            background: var(--bg-tertiary); 
            color: var(--text-tertiary); 
            border: 1px solid var(--border-color); 
            padding: 12px 5px; 
            border-radius: 8px; 
            text-align: center; 
            font-size: 13px; 
            box-sizing: border-box; 
        }
        input, select { 
            flex: 1; 
            min-width: 0; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 15px; 
            background: var(--bg-tertiary); 
            color: var(--text-primary); 
            box-sizing: border-box; 
        }
        
        /* ì…ë ¥ ìƒì ë‚´ë¶€ ì‚­ì œ ë²„íŠ¼ */
        .input-wrapper { position: relative; flex: 1; display: flex; align-items: center; min-width: 0; }
        .input-wrapper input { flex: 1; min-width: 0; }
        .input-with-clear { padding-right: 40px !important; }
        .clear-btn { 
            position: absolute; 
            right: 8px; 
            background: #8e8e93; 
            border: none; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            color: white; 
            font-size: 14px; 
            cursor: pointer; 
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .clear-btn:active { background: #636366; }
        
        /* ë‚ ì§œ ì…ë ¥ */
        input[type="date"] {
            color-scheme: light dark;
            -webkit-appearance: none;
        }
        body.light-mode input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0);
        }
        body:not(.light-mode) input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        button { padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #0a84ff; color: white; width: 100%; margin-top: 10px; }
        .btn-green { background: #30d158; color: white; width: 100%; margin-top: 10px; }
        .btn-red { background: #ff453a; color: white; width: 70px; font-size: 13px; flex-shrink: 0; }
        .btn-gray { background: #8e8e93; color: white; width: 70px; font-size: 13px; flex-shrink: 0; }
        .btn-orange { background: #ff9f0a; color: white; width: 100%; margin-top: 10px; }
        .btn-purple { background: #bf5af2; color: white; width: 100%; margin-top: 10px; }
        
        #status { text-align: center; margin-top: 15px; font-weight: 600; color: #0a84ff; }
        #openFilesBtn, #openDriveBtn { display: none; }
        
        /* í…Œë§ˆ í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .toggle-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #8e8e93;
            transition: .3s;
            border-radius: 31px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #0a84ff;
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        /* í™”ë©´ ì „í™˜ */
        .screen { display: none; }
        .screen.active { display: block; }
        
        .setting-description {
            text-align: center;
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 10px;
        }
        
        /* í´ë¼ìš°ë“œ ì—°ê²° ìƒíƒœ */
        .cloud-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .cloud-status.connected {
            border-color: #30d158;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #8e8e93;
        }
        .status-indicator.connected {
            background: #30d158;
        }
        .cloud-email {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }
    </style>
</head>
<body>

<div id="mainScreen" class="screen active">
    <div class="header">
        <h1>í˜„ì¥ ì‚¬ì§„ Pro</h1>
        <button class="settings-btn" onclick="showSettings()">âš™ï¸</button>
    </div>

    <div class="card">
        <h3>ğŸ“‹ í‘œ ë‚´ìš© ì…ë ¥</h3>
        <div id="tableFields"></div>
    </div>

    <div class="card">
        <h3>ğŸ’¾ í…œí”Œë¦¿ ê´€ë¦¬</h3>
        <div class="row">
            <select id="templateList" onchange="loadTemplate()"><option value="">í…œí”Œë¦¿ ì„ íƒ</option></select>
            <button class="btn-red" onclick="deleteTemplate()">ì‚­ì œ</button>
        </div>
        <div class="row">
            <div class="input-wrapper">
                <input type="text" id="newTemplateName" class="input-with-clear" placeholder="ìƒˆ ì´ë¦„" oninput="toggleClearBtn()">
                <button class="clear-btn" id="clearNameBtn" onclick="clearTemplateName()">âœ•</button>
            </div>
            <button class="btn-gray" onclick="saveTemplate()">ì €ì¥</button>
        </div>
    </div>

    <div class="card">
        <input type="file" id="imageInput" multiple accept="image/jpeg,image/jpg,image/heic,image/heif" style="display: none;">
        <button class="btn-blue" onclick="document.getElementById('imageInput').click()">ğŸ“¸ ì‚¬ì§„ ì„ íƒ & ì‘ì—… ì‹œì‘</button>
        <div id="status">ëŒ€ê¸° ì¤‘...</div>
        <button id="openFilesBtn" class="btn-green" onclick="openFilesApp()">ğŸ“‚ íŒŒì¼ ì•± ì—´ê¸°</button>
        <button id="uploadToDriveBtn" class="btn-purple" onclick="manualUploadToDrive()" style="display: none;">â˜ï¸ Driveì— ì—…ë¡œë“œ</button>
        <button id="openDriveBtn" class="btn-purple" onclick="openDriveFolder()" style="display: none;">ğŸ“‚ Driveì—ì„œ ë³´ê¸°</button>
    </div>

    <div class="card">
        <h3>ğŸ’¾ í…œí”Œë¦¿ ë°±ì—… & ë³µì›</h3>
        <button class="btn-blue" onclick="exportTemplates()">ğŸ“¤ í…œí”Œë¦¿ ë‚´ë³´ë‚´ê¸° (JSON)</button>
        <input type="file" id="importInput" accept="application/json" style="display: none;" onchange="importTemplates(event)">
        <button class="btn-green" onclick="document.getElementById('importInput').click()">ğŸ“¥ í…œí”Œë¦¿ ê°€ì ¸ì˜¤ê¸° (JSON)</button>
    </div>
    
    <div style="text-align: center; padding: 20px 0; color: var(--text-tertiary); font-size: 13px;">
        ë§Œë“  ì´ Juneui
    </div>
</div>

<div id="settingsScreen" class="screen">
    <div class="header">
        <button class="back-btn" onclick="showMain()">â† ë’¤ë¡œê°€ê¸°</button>
        <h1 style="margin-left: auto;">ì„¤ì •</h1>
    </div>

    <div class="card">
        <h3>â˜ï¸ Google Drive ì—°ë™</h3>
        <div class="cloud-status" id="driveStatus">
            <div class="status-indicator" id="driveIndicator"></div>
            <span class="cloud-email" id="driveEmail">ì—°ê²°ë˜ì§€ ì•ŠìŒ</span>
        </div>
        <button class="btn-blue" id="driveConnectBtn" onclick="connectGoogleDrive()">Google ê³„ì • ì—°ê²°</button>
        <button class="btn-red" id="driveDisconnectBtn" onclick="disconnectGoogleDrive()" style="display: none; width: 100%;">ì—°ê²° í•´ì œ</button>
        
        <div class="toggle-row" style="margin-top: 15px;">
            <span class="toggle-label">Drive ìë™ ì—…ë¡œë“œ</span>
            <label class="switch">
                <input type="checkbox" id="driveAutoUpload" onchange="toggleDriveSettings()">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="toggle-row" style="margin-top: 15px;">
            <span class="toggle-label">í™•ì¸ í›„ ì—…ë¡œë“œ</span>
            <label class="switch">
                <input type="checkbox" id="driveManualUpload" onchange="toggleDriveSettings()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-description">âš ï¸ 1ì‹œê°„ë§ˆë‹¤ ì¬ì—°ê²° í•„ìš”</div>
    </div>

    <div class="card">
        <h3>ğŸ¨ í…Œë§ˆ ì„¤ì •</h3>
        <div class="toggle-row">
            <span class="toggle-label">ë‹¤í¬ ëª¨ë“œ</span>
            <label class="switch">
                <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-description">ë°ì€ í™”ë©´ì„ ì›í•˜ì‹œë©´ í† ê¸€ì„ ë„ì„¸ìš”</div>
    </div>

    <div class="card">
        <h3>ğŸ“ í‘œ í¬ê¸° ì„¤ì •</h3>
        <div style="padding: 10px 0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: var(--text-primary); font-size: 14px;">í‘œ í¬ê¸°</span>
                <span id="tableSizeValue" style="color: #0a84ff; font-weight: bold;">100%</span>
            </div>
            <input type="range" id="tableSizeSlider" min="50" max="150" value="100" 
                   style="width: 100%; height: 6px; border-radius: 3px; background: var(--bg-tertiary); 
                          border: 1px solid var(--border-color); cursor: pointer;"
                   oninput="updateTableSize(this.value)">
            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px; color: var(--text-tertiary);">
                <span>50%</span>
                <span>100%</span>
                <span>150%</span>
            </div>
        </div>
        <div class="setting-description">í‘œì˜ ì „ì²´ í¬ê¸°ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤</div>
    </div>

    <div class="card">
        <h3>ğŸ”„ ì•± ì—…ë°ì´íŠ¸</h3>
        <button class="btn-orange" onclick="updateApp()">ğŸ”„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸</button>
        <div class="setting-description">ìºì‹œë¥¼ ì‚­ì œí•˜ê³  ìµœì‹  ë²„ì „ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</div>
    </div>
</div>

<script>
    // ========== ì„¤ì • í‚¤ ==========
    const storageKey = 'photo_pro_v8_final';
    const themeKey = 'photo_pro_theme';
    const driveKey = 'photo_pro_drive';
    const tableSizeKey = 'photo_pro_table_size';
    
    // ========== Google Drive API ì„¤ì • ==========
    const GOOGLE_CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';
    const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
    
    // ========== ì „ì—­ ë³€ìˆ˜ ==========
    let gapiInited = false;
    let googleTokenClient;
    let googleAccessToken = null;
    let googleLastFolderId = null;
    
    let currentZipBlob = null;
    let currentZipFileName = null;
    let tableSize = 100; 
    
    const statusText = document.getElementById('status');
    const openFilesBtn = document.getElementById('openFilesBtn');
    const today = new Date();
    const dateStr = `${today.getFullYear()}ë…„ ${String(today.getMonth() + 1).padStart(2, '0')}ì›” ${String(today.getDate()).padStart(2, '0')}ì¼`;
    
    let currentTemplateName = "";
    let currentData = [
        {k: "ê³µì‚¬ëª…", v: ""}, {k: "ì‹œë£Œë²ˆí˜¸", v: ""},
        {k: "ì¼ì", v: dateStr}, {k: "ì±„ì·¨êµ¬ë¶„", v: ""}, {k: "ì¡°ì‚¬ì", v: ""}
    ];

    // ... (Google API ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµí•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤) ...
    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() { await gapi.client.init({ discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'], }); gapiInited = true; checkDriveConnection(); }
    function gisLoaded() { googleTokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_SCOPES, prompt: '', callback: async (response) => { if (response.error !== undefined) { throw (response); } googleAccessToken = response.access_token; await saveGoogleToken(response); await updateDriveStatus(); alert('Google Driveì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!'); }, }); }
    async function connectGoogleDrive() { if (!gapiInited || !googleTokenClient) { alert('Google API ë¡œë”© ì¤‘...'); return; } googleTokenClient.requestAccessToken({ prompt: 'consent' }); }
    async function disconnectGoogleDrive() { if (confirm('í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { if (googleAccessToken) google.accounts.oauth2.revoke(googleAccessToken); localStorage.removeItem(driveKey); googleAccessToken = null; await updateDriveStatus(); alert('í•´ì œë¨'); } }
    async function saveGoogleToken(response) { const driveData = { access_token: response.access_token, expires_at: Date.now() + (response.expires_in * 1000), autoUpload: document.getElementById('driveAutoUpload').checked, manualUpload: document.getElementById('driveManualUpload').checked }; try { const userInfo = await gapi.client.request({ path: 'https://www.googleapis.com/oauth2/v2/userinfo' }); driveData.email = userInfo.result.email; } catch (err) {} localStorage.setItem(driveKey, JSON.stringify(driveData)); }
    async function loadGoogleToken() { const saved = localStorage.getItem(driveKey); if (!saved) return false; const driveData = JSON.parse(saved); if (Date.now() >= (driveData.expires_at - 300000)) return false; googleAccessToken = driveData.access_token; gapi.client.setToken({ access_token: googleAccessToken }); document.getElementById('driveAutoUpload').checked = driveData.autoUpload || false; document.getElementById('driveManualUpload').checked = driveData.manualUpload || false; return true; }
    async function checkDriveConnection() { await loadGoogleToken(); await updateDriveStatus(); }
    async function updateDriveStatus() { const status = document.getElementById('driveStatus'); const indicator = document.getElementById('driveIndicator'); const email = document.getElementById('driveEmail'); const connectBtn = document.getElementById('driveConnectBtn'); const disconnectBtn = document.getElementById('driveDisconnectBtn'); const saved = localStorage.getItem(driveKey); if (googleAccessToken && saved) { const driveData = JSON.parse(saved); status.classList.add('connected'); indicator.classList.add('connected'); email.textContent = driveData.email || 'ì—°ê²°ë¨'; connectBtn.style.display = 'none'; disconnectBtn.style.display = 'block'; } else { status.classList.remove('connected'); indicator.classList.remove('connected'); email.textContent = 'ì—°ê²°ë˜ì§€ ì•ŠìŒ'; connectBtn.style.display = 'block'; disconnectBtn.style.display = 'none'; } }
    function toggleDriveSettings() { const saved = localStorage.getItem(driveKey); if (saved) { const driveData = JSON.parse(saved); driveData.autoUpload = document.getElementById('driveAutoUpload').checked; driveData.manualUpload = document.getElementById('driveManualUpload').checked; localStorage.setItem(driveKey, JSON.stringify(driveData)); } }
    async function ensureValidGoogleToken() { const saved = localStorage.getItem(driveKey); if (!saved) return false; const driveData = JSON.parse(saved); if (Date.now() >= (driveData.expires_at - 300000)) { alert('Google ì—°ê²° ë§Œë£Œ'); googleAccessToken = null; return false; } return true; }
    async function uploadToGoogleDrive(blob, fileName) { if (!await ensureValidGoogleToken()) throw new Error('ì—°ê²° ë§Œë£Œ'); if (!googleAccessToken) throw new Error('ì—°ê²° ì•ˆë¨'); const metadata = { name: fileName, mimeType: 'application/zip' }; const form = new FormData(); form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' })); form.append('file', blob); const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { 'Authorization': `Bearer ${googleAccessToken}` }, body: form }); if (!response.ok) throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨'); const result = await response.json(); googleLastFolderId = result.id; return result; }
    function openDriveFolder() { if (googleLastFolderId) window.open(`https://drive.google.com/file/d/${googleLastFolderId}/view`, '_blank'); else window.open('https://drive.google.com/drive/my-drive', '_blank'); }
    async function manualUploadToDrive() { if (!currentZipBlob || !currentZipFileName) return alert('íŒŒì¼ ì—†ìŒ'); if (!await ensureValidGoogleToken()) return alert('ì—°ê²° ë§Œë£Œ'); if (!googleAccessToken) return alert('ì—°ê²° í•„ìš”'); try { statusText.innerText = 'ì—…ë¡œë“œ ì¤‘...'; document.getElementById('uploadToDriveBtn').disabled = true; await uploadToGoogleDrive(currentZipBlob, currentZipFileName); statusText.innerText = 'ì™„ë£Œ!'; document.getElementById('uploadToDriveBtn').style.display = 'none'; document.getElementById('openDriveBtn').style.display = 'block'; } catch (error) { statusText.innerText = 'ì‹¤íŒ¨: ' + error.message; alert('ì‹¤íŒ¨'); document.getElementById('uploadToDriveBtn').disabled = false; } }

    function showSettings() { document.getElementById('mainScreen').classList.remove('active'); document.getElementById('settingsScreen').classList.add('active'); }
    function showMain() { document.getElementById('settingsScreen').classList.remove('active'); document.getElementById('mainScreen').classList.add('active'); }
    function toggleTheme() { if (document.getElementById('themeToggle').checked) { document.body.classList.remove('light-mode'); localStorage.setItem(themeKey, 'dark'); } else { document.body.classList.add('light-mode'); localStorage.setItem(themeKey, 'light'); } }
    function loadTheme() { if ((localStorage.getItem(themeKey) || 'dark') === 'light') { document.body.classList.add('light-mode'); document.getElementById('themeToggle').checked = false; } else { document.body.classList.remove('light-mode'); document.getElementById('themeToggle').checked = true; } }
    function updateTableSize(v) { tableSize = parseInt(v); document.getElementById('tableSizeValue').textContent = v + '%'; localStorage.setItem(tableSizeKey, tableSize); }
    function loadTableSize() { const s = localStorage.getItem(tableSizeKey); if (s) { tableSize = parseInt(s); document.getElementById('tableSizeSlider').value = tableSize; document.getElementById('tableSizeValue').textContent = tableSize + '%'; } }

    function formatDateToKorean(date) { return `${date.getFullYear()}ë…„ ${String(date.getMonth() + 1).padStart(2, '0')}ì›” ${String(date.getDate()).padStart(2, '0')}ì¼`; }
    function koreanToISO(k) { const m = k.match(/(\d{4})ë…„ (\d{2})ì›” (\d{2})ì¼/); return m ? `${m[1]}-${m[2]}-${m[3]}` : ''; }
    function renderFields() { const c = document.getElementById('tableFields'); c.innerHTML = ''; currentData.forEach((item, i) => { const row = document.createElement('div'); row.className = 'row'; if (item.k === "ì¼ì") { row.innerHTML = `<input type="text" class="col-key" value="${item.k}" oninput="currentData[${i}].k=this.value"><input type="date" value="${koreanToISO(item.v)}" onchange="updateDateField(${i}, this.value)">`; } else { row.innerHTML = `<input type="text" class="col-key" value="${item.k}" oninput="currentData[${i}].k=this.value"><div class="input-wrapper"><input type="text" class="input-with-clear" value="${item.v}" oninput="currentData[${i}].v=this.value; toggleFieldClearBtn(${i})"><button class="clear-btn" id="clearValue${i}" onclick="clearFieldInput(${i})">âœ•</button></div>`; } c.appendChild(row); if (item.k !== "ì¼ì") setTimeout(() => toggleFieldClearBtn(i), 0); }); }
    function updateDateField(i, v) { if (v) { const [y, m, d] = v.split('-'); currentData[i].v = `${y}ë…„ ${m}ì›” ${d}ì¼`; } }
    function getShortDate(s) { const m = s.match(/(\d{4})ë…„ (\d{2})ì›” (\d{2})ì¼/); return m ? (m[1].substring(2) + m[2] + m[3]) : "000000"; }

    function toRational(n) { const t = 1.0E-6; let num = 1, den = 1; while (Math.abs(n - Math.round(n)) > t && den < 100000) { n *= 10; den *= 10; } return [Math.round(n), den]; }
    function degToDmsRational(d) { const abs = Math.abs(d); const deg = Math.floor(abs); const minF = (abs - deg) * 60; const min = Math.floor(minF); const sec = Math.round((minF - min) * 60 * 10000); return [[deg, 1], [min, 1], [sec, 10000]]; }

    // ========== í•µì‹¬ ìˆ˜ì •: ë””ë²„ê¹… ë° EXIF ì¶”ì¶œ ë¡œì§ ==========
    async function getExifDateTime(file) {
        try {
            // exifrë¡œ ë‚ ì§œ í™•ì¸
            const metadata = await exifr.parse(file, {pick: ['DateTimeOriginal', 'CreateDate', 'DateTimeDigitized']});
            if (metadata && (metadata.DateTimeOriginal || metadata.CreateDate)) {
                return new Date(metadata.DateTimeOriginal || metadata.CreateDate);
            }
            return new Date(0);
        } catch (err) {
            return new Date(0);
        }
    }

document.getElementById('imageInput').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    if (!files.length) return;
    
    openFilesBtn.style.display = 'none';
    document.getElementById('openDriveBtn').style.display = 'none';
    document.getElementById('uploadToDriveBtn').style.display = 'none';
    statusText.innerText = 'ì‚¬ì§„ ë¶„ì„ ë° ì²˜ë¦¬ ì¤‘...';
    
    // ì•Œë¦¼ì°½ ì—†ì´ ì¡°ìš©íˆ ë‚ ì§œ ì¶”ì¶œ ë° ì •ë ¬
    const filesWithTime = await Promise.all(
        files.map(async (file) => ({
            file: file,
            time: await getExifDateTime(file)
        }))
    );
    
    filesWithTime.sort((a, b) => a.time - b.time);
    const sortedFiles = filesWithTime.map(item => item.file);
    
    const zip = new JSZip();
    const baseTitle = currentTemplateName || currentData[0].v || "í˜„ì¥ì‚¬ì§„";
    const sampleNumber = currentData[1].v;
    const datePart = getShortDate(currentData[2].v);
    const zipFileName = sampleNumber ? `${baseTitle} ${sampleNumber} ${datePart}`.trim() : `${baseTitle} ${datePart}`.trim();
    const photoBaseName = sampleNumber || "ì‚¬ì§„";
    
    for (let i = 0; i < sortedFiles.length; i++) {
        statusText.innerText = `${i+1}/${sortedFiles.length}ê°œ ì²˜ë¦¬ ì¤‘...`;
        const blob = await processImage(sortedFiles[i]);
        zip.file(`${photoBaseName} (${i+1}).jpg`, blob);
    }

    const content = await zip.generateAsync({type: "blob"});
    currentZipBlob = content;
    currentZipFileName = `${zipFileName}.zip`;
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(content);
    link.download = currentZipFileName;
    link.click();
    
    statusText.innerText = "ë¡œì»¬ ì €ì¥ ì™„ë£Œ!";
    openFilesBtn.style.display = 'block';

    // Google Drive ì—…ë¡œë“œ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    const driveData = localStorage.getItem(driveKey);
    const driveSettings = driveData ? JSON.parse(driveData) : null;
    if (driveSettings && driveSettings.autoUpload && googleAccessToken) {
        if (driveSettings.manualUpload) {
            document.getElementById('uploadToDriveBtn').style.display = 'block';
        } else {
            try {
                statusText.innerText = 'Drive ì—…ë¡œë“œ ì¤‘...';
                await uploadToGoogleDrive(content, currentZipFileName);
                statusText.innerText = 'ëª¨ë“  ì‘ì—… ì™„ë£Œ!';
                document.getElementById('openDriveBtn').style.display = 'block';
            } catch (error) {
                statusText.innerText = 'ë¡œì»¬ ì €ì¥ ì„±ê³µ (Drive ì—…ë¡œë“œ ì‹¤íŒ¨)';
            }
        }
    }
});

    async function processImage(file) {
    // 1. ì›ë³¸ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
    let extractedExif = null;
    try {
        extractedExif = await exifr.parse(file, {
            tiff: true, exif: true, gps: true, reviveValues: true
        });
    } catch (e) { console.warn("EXIF ì¶”ì¶œ ì‹¤íŒ¨", e); }

    return new Promise(res => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const originalDataUrl = e.target.result;
            const img = new Image();
            img.src = originalDataUrl;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width; 
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                // --- í‘œ ê·¸ë¦¬ê¸° (ê¸°ì¡´ ë¡œì§ ìœ ì§€) ---
                const scale = tableSize / 100;
                const rowH = canvas.height * 0.045 * scale;
                const fontSize = rowH * 0.75;
                ctx.font = `${fontSize}px Arial`;
                ctx.textBaseline = 'middle';
                let maxVWidth = 0;
                currentData.forEach(d => { if(ctx.measureText(d.v).width > maxVWidth) maxVWidth = ctx.measureText(d.v).width; });
                const keyWidth = ctx.measureText("ê³µì‚¬ëª…ì¼ì").width;
                const padding = 40 * scale; 
                const tableW = keyWidth + maxVWidth + (padding * 4);
                const tableH = rowH * 5;
                const x = 0; const y = canvas.height - tableH;
                ctx.fillStyle = "white"; ctx.fillRect(x, y, tableW, tableH);
                ctx.strokeStyle = "black"; ctx.lineWidth = canvas.width * 0.0015; ctx.fillStyle = "black";
                currentData.forEach((item, i) => {
                    const cy = y + (i * rowH);
                    ctx.strokeRect(x, cy, tableW, rowH);
                    const splitX = x + keyWidth + (padding * 2);
                    ctx.beginPath(); ctx.moveTo(splitX, cy); ctx.lineTo(splitX, cy+rowH); ctx.stroke();
                    ctx.fillText(item.k, x + padding, cy + (rowH * 0.5));
                    ctx.fillText(item.v, splitX + padding, cy + (rowH * 0.5));
                });

                // 2. ìƒˆë¡œìš´ JPEG ìƒì„± í›„ EXIF ì£¼ì…
                canvas.toBlob(blob => {
                    const reader2 = new FileReader();
                    reader2.readAsDataURL(blob);
                    reader2.onload = (e2) => {
                        const newDataUrl = e2.target.result;
                        try {
                            const zeroth = {};
                            const exif = {};
                            const gps = {};

                            if (extractedExif) {
                                // ì œì¡°ì‚¬ ì •ë³´
                                zeroth[piexif.ImageIFD.Make] = String(extractedExif.Make || "Apple");
                                zeroth[piexif.ImageIFD.Model] = String(extractedExif.Model || "iPhone");
                                
                                // ë‚ ì§œ ì •ë³´ (ë§¤ìš° ì¤‘ìš”: YYYY:MM:DD HH:MM:SS í˜•ì‹)
                                let targetDate = extractedExif.DateTimeOriginal || extractedExif.CreateDate || new Date();
                                let dateStr = formatDateForExif(targetDate);
                                
                                zeroth[piexif.ImageIFD.DateTime] = dateStr;
                                exif[piexif.ExifIFD.DateTimeOriginal] = dateStr;
                                exif[piexif.ExifIFD.DateTimeDigitized] = dateStr;

                                // GPS ì •ë³´
                                if (extractedExif.latitude && extractedExif.longitude) {
                                    gps[piexif.GPSIFD.GPSVersionID] = [2, 2, 0, 0];
                                    gps[piexif.GPSIFD.GPSLatitudeRef] = extractedExif.latitude < 0 ? 'S' : 'N';
                                    gps[piexif.GPSIFD.GPSLatitude] = degToDmsRational(extractedExif.latitude);
                                    gps[piexif.GPSIFD.GPSLongitudeRef] = extractedExif.longitude < 0 ? 'W' : 'E';
                                    gps[piexif.GPSIFD.GPSLongitude] = degToDmsRational(extractedExif.longitude);
                                    if (extractedExif.altitude) {
                                        gps[piexif.GPSIFD.GPSAltitudeRef] = 0;
                                        gps[piexif.GPSIFD.GPSAltitude] = toRational(Math.abs(extractedExif.altitude));
                                    }
                                }
                            }

                            const exifObj = { "0th": zeroth, "Exif": exif, "GPS": gps };
                            const exifStr = piexif.dump(exifObj);
                            const finalDataUrl = piexif.insert(exifStr, newDataUrl);
                            
                            fetch(finalDataUrl).then(r => r.blob()).then(res);
                        } catch (err) {
                            console.error("ë©”íƒ€ë°ì´í„° ì£¼ì… ì¤‘ ì˜¤ë¥˜:", err);
                            res(blob); // ì—ëŸ¬ ì‹œ ìµœì†Œí•œ ì‚¬ì§„ì´ë¼ë„ ì €ì¥
                        }
                    };
                }, "image/jpeg", 0.95);
            }
        }
    });
}
    function formatDateForExif(date) {
        if (!date) return null;
        if (typeof date === 'string') return date;
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        const s = String(date.getSeconds()).padStart(2, '0');
        return `${y}:${m}:${d} ${h}:${min}:${s}`;
    }

    // ë‚˜ë¨¸ì§€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (íŒŒì¼ì•±ì—´ê¸°, í…œí”Œë¦¿ ê´€ë ¨ ë“±)ì€ ê¸°ì¡´ ì½”ë“œ ìœ ì§€
    function openFilesApp() {
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        if (isIOS) window.location.href = 'shareddocuments://';
        else if (isAndroid) alert('ë‹¤ìš´ë¡œë“œ í´ë” í™•ì¸');
        else alert('ë‹¤ìš´ë¡œë“œë¨');
    }
    function saveTemplate() { const name = document.getElementById('newTemplateName').value; if(!name) return alert("ì´ë¦„ ì…ë ¥"); let t = JSON.parse(localStorage.getItem(storageKey) || '{}'); t[name] = JSON.parse(JSON.stringify(currentData)); localStorage.setItem(storageKey, JSON.stringify(t)); currentTemplateName = name; updateTmplList(); document.getElementById('templateList').value = name; alert("ì €ì¥ë¨"); }
    function loadTemplate() { const n = document.getElementById('templateList').value; const nameInput = document.getElementById('newTemplateName'); if(!n) { currentTemplateName = ""; nameInput.value = ""; toggleClearBtn(); return; } const t = JSON.parse(localStorage.getItem(storageKey) || '{}'); if(t[n]) { currentData = t[n]; currentData[2].v = dateStr; currentTemplateName = n; nameInput.value = n; toggleClearBtn(); renderFields(); } }
    function deleteTemplate() { const n = document.getElementById('templateList').value; if(!n || !confirm("ì‚­ì œ?")) return; let t = JSON.parse(localStorage.getItem(storageKey) || '{}'); delete t[n]; localStorage.setItem(storageKey, JSON.stringify(t)); if(currentTemplateName === n) { currentTemplateName = ""; document.getElementById('newTemplateName').value = ""; } updateTmplList(); }
    function updateTmplList() { const s = document.getElementById('templateList'); const t = JSON.parse(localStorage.getItem(storageKey) || '{}'); s.innerHTML = '<option value="">í…œí”Œë¦¿ ì„ íƒ</option>'; for(let n in t) s.innerHTML += `<option value="${n}">${n}</option>`; }
    function clearTemplateName() { document.getElementById('newTemplateName').value = ''; document.getElementById('clearNameBtn').style.display = 'none'; }
    function toggleClearBtn() { const input = document.getElementById('newTemplateName'); document.getElementById('clearNameBtn').style.display = input.value ? 'flex' : 'none'; }
    function clearFieldInput(i) { currentData[i].v = ''; renderFields(); }
    function toggleFieldClearBtn(i) { const btn = document.getElementById(`clearValue${i}`); if (btn) btn.style.display = currentData[i].v ? 'flex' : 'none'; }
    function exportTemplates() { const t = localStorage.getItem(storageKey); if (!t || t === '{}') return alert('ì—†ìŒ'); const d = "data:text/json;charset=utf-8," + encodeURIComponent(t); const a = document.createElement('a'); a.href = d; a.download = "photo_pro_templates.json"; a.click(); alert('ë‚´ë³´ë‚´ê¸° ì™„ë£Œ'); }
    function importTemplates(e) { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = function(e) { try { const d = JSON.parse(e.target.result); const ex = JSON.parse(localStorage.getItem(storageKey) || '{}'); localStorage.setItem(storageKey, JSON.stringify({...ex, ...d})); updateTmplList(); alert('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ'); } catch (error) { alert('íŒŒì¼ ì˜¤ë¥˜'); } }; r.readAsText(f); }
    function updateApp() { if (confirm('ì—…ë°ì´íŠ¸?')) window.location.reload(true); }

    window.onload = async () => { renderFields(); updateTmplList(); loadTheme(); loadTableSize(); if (typeof gapi !== 'undefined') gapiLoaded(); if (typeof google !== 'undefined') gisLoaded(); };
</script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
